{% extends 'admin/layout/dashboard_base.html' %} 

{% load static %}
{% load crispy_forms_tags %}

{% block title %}
Vacantes Propias
{% endblock %}



{% block content %}
<div class="main-content-container overflow-hidden">
	<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
		<h3 class="mb-0" style="color: #B10022;">CLIENTE: {{data.cliente.razon_social}}</h3>
		<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
			<ol class="breadcrumb align-items-center mb-0 lh-1">
				<li class="breadcrumb-item">
					<a href="#" class="d-flex align-items-center text-decoration-none">
						<i class="ri-home-4-line fs-18 text-primary me-1"></i>
						<span class="text-secondary fw-medium hover" >Inicio</span>
					</a>
				</li>
                {% if request.session.grupo_id == 1 %}
				<li class="breadcrumb-item active" aria-current="page">
					<a href="{% url 'clientes:cliente_ver' %}" class="d-flex align-items-center text-decoration-none">
						<span class="text-secondary fw-medium hover" >Listado de Clientes</span>
					</a>
				</li>
				{% endif %}
				{% if request.session.grupo_id == 3 and request.session.user_login.cliente_tipo == '3' %}
				<li class="breadcrumb-item active" aria-current="page">
					<a href="{% url 'vacantes:vacantes_listado_cliente' %}" class="d-flex align-items-center text-decoration-none">
						<span class="text-secondary fw-medium hover" >Vacantes Propias</span>
					</a>
				</li>
				{% endif %}
				{% if request.session.grupo_id == 3 and request.session.user_login.cliente_tipo == '2' %}
				<li class="breadcrumb-item active" aria-current="page">
					<a href="{% url 'clientes:client_headhunter_asignados' %}" class="d-flex align-items-center text-decoration-none">
						<span class="text-secondary fw-medium hover" >Clientes Asignados</span>
					</a>
				</li>
                <li class="breadcrumb-item active" aria-current="page">
					<a href="{% url 'vacantes:vacantes_propias' data.cliente.id %}" class="d-flex align-items-center text-decoration-none">
						<span class="text-secondary fw-medium hover" >Vacantes Propias</span>
					</a>
				</li>
				{% endif %}
                {% if request.session.grupo_id == 5 %}
                <li class="breadcrumb-item active" aria-current="page">
					<a href="{% url 'vacantes:vacantes_asignadas' %}" class="d-flex align-items-center text-decoration-none">
						<span class="text-secondary fw-medium hover" >Vacantes Asignadas</span>
					</a>
				</li>
				{% endif %}
				<li class="breadcrumb-item active" aria-current="page">
					<span class="fw-medium">Gestión de Vacante</span>
				</li>
			</ol>
		</nav>
	</div>
    
    
    {% if request.session.grupo_id == 1 %}
    <!-- Contenido para admin -->
    <div class="row">
		<div class="col-md-12">
			{% include 'admin/client/admin_user/common_template/client_menu_horizontal.html' with elements_vacancy=True %}
		</div>
	</div>
    {% else %}
        {% if request.session.grupo_id == 3 and request.session.user_login.cliente_tipo == '2' %}
        <div class="row">
            <div class="col-md-12">
                {% include 'admin/client/admin_user/common_template/client_menu_horizontal.html' with elements_vacancy=True %}
            </div>
        </div>
        {% endif %}
    {% endif %}

	<div class="row">
        <div class="col-md-12">
			<div class="card bg-white border-0 rounded-3 mb-4">
                <div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
                    <p class="text-primary my-2 fs-4 fw-semibold">Gestión Vacante: {{vacante.titulo}}</p>
                </div>
                <div class="card-body p-4">
                    <nav>
                        <div class="nav nav-tabs mb-4" id="nav-tab" role="tablist">
                            <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">Información</button>
                            <button class="nav-link" id="nav-reclutado-tab" data-bs-toggle="tab" data-bs-target="#nav-reclutado" type="button" role="tab" aria-controls="nav-reclutado" aria-selected="false">Reclutados</button>
                            <button class="nav-link" id="nav-entrevista-tab" data-bs-toggle="tab" data-bs-target="#nav-entrevista" type="button" role="tab" aria-controls="nav-entrevista" aria-selected="false">Entrevista</button>
                            <button class="nav-link" id="nav-contact-tab" data-bs-toggle="tab" data-bs-target="#nav-contact" type="button" role="tab" aria-controls="nav-contact" aria-selected="false">Preguntas Vacante</button>
                            {% if request.session.grupo_id != 5  %}
                            <button class="nav-link" id="nav-analista-tab" data-bs-toggle="tab" data-bs-target="#nav-analista" type="button" role="tab" aria-controls="nav-analista" aria-selected="false">Analista</button>
                            {% endif %}
                        </div>
                    </nav>
                    <div class="tab-content" id="nav-tabContent">
                        <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" tabindex="0">
                            {% include 'admin/vacancy/partials/presentation_vacancy.html' %}
                        </div>
                        <div class="tab-pane fade" id="nav-reclutado" role="tabpanel" aria-labelledby="nav-reclutado-tab" tabindex="0">
                            <div class="default-table-area all-projects">
                                <div class="table-responsive">
                                    <table class="table align-middle text-center" id="reclutamiento-tabla">
                                        <thead>
                                            <tr>
                                                <th scope="col">ID</th>
                                                <th scope="col">DOCUMENTO</th>
                                                <th scope="col">CANDIDATO</th>
                                                <th scope="col">ESTADO</th>
                                                <th scope="col">ACCIONES</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for e in reclutados %}
                                            <tr>
                                                <td class="text-body">{{e.id}}</td>
                                                <td class="text-body">{{e.candidato_documento}}</td>

                                                <td>
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        {% if e.candidato_imagen_perfil %}
                                                            <img src="/media_uploads/{{ e.candidato_imagen_perfil}}" class="wh-40 rounded-3" alt="{{ e.candidato_imagen_perfil }}">
                                                        {% else %}
                                                            <img src="{% static 'admin/images/blank.png' %}" class="wh-40 rounded-3" alt="user">
                                                        {% endif %}
                                                        
                                                        <div class="ms-2 ps-1">
                                                            <a href="{% url 'reclutados:reclutados_detalle_cliente' e.id  %}" class="fw-medium">{{e.candidato_nombre}}</a>
                                                        </div>
                                                    </div>
                                                    
                                                </td>
                                                <td>
                                                    <span class="badge bg-opacity-10 bg-{{e.obtener_estado_con_color.color}} py-1 px-2 text-{{e.obtener_estado_con_color.color}} rounded-1 fw-medium fs-12">{{e.obtener_estado_con_color.estado}}</span>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center justify-content-center gap-1">
                                                        <!-- 
                                                        <a href="#" class="ps-0 border-0 bg-transparent lh-1 position-relative top-2">
                                                            <i class="material-symbols-outlined fs-16 text-primary">visibility</i>
                                                        </a>
                                                        -->
                                                        <div class="d-flex justify-content-center align-items-center gap-1" alt="Gestionar" title="Gestionar">
                                                            <a href="{% url 'reclutados:reclutados_detalle_cliente' e.id  %}" class="btn bg-danger bg-opacity-10 fw-medium text-danger py-2 px-4">
                                                                <i class="material-symbols-outlined fs-16 text-danger">manage_accounts</i>
                                                            </a>
                                                        </div>
                                                        
                                                        <!-- 
                                                        <a href="#" class="ps-0 border-0 bg-transparent lh-1 position-relative top-2">
                                                            <i class="material-symbols-outlined fs-16 text-danger">delete</i>
                                                        </a>
                                                        -->
                                                    </div>
                                                </td> 
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="nav-entrevista" role="tabpanel" aria-labelledby="nav-entrevista-tab" tabindex="0">
                            <div class="default-table-area all-projects">
                                <div class="table-responsive">
                                    <table class="table align-middle text-center" id="entrevista-tabla">
                                        <thead>
                                            <tr>
                                                <th scope="col">ID</th>
                                                <th scope="col">FECHA</th>
                                                <th scope="col">HORA</th>
                                                <th scope="col">LUGAR / ENLACE</th>
                                                <th scope="col">TIPO ASIGNACION</th>
                                                <th scope="col">CANDIDATO</th>
                                                <th scope="col">ANALISTA RESPONSABLE</th>
                                                <th scope="col">ESTADO</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for e in entrevistas %}
                                            <tr>
                                                <td class="text-body">{{e.id}}</td>
                                                <td class="text-body">{{e.fecha_entrevista}}</td>
                                                <td class="text-body">{{e.hora_entrevista}}</td>
                                                <td class="text-body">{{e.lugar_enlace}}</td>
                                                <td class="text-body">{{e.obtener_tipo_entrevista}}</td>
                                                <td>
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        {% if e.imagen_candidato %}
                                                            <img src="/media_uploads/{{ e.imagen_candidato}}" class="wh-40 rounded-3" alt="{{ e.imagen_candidato }}">
                                                        {% else %}
                                                            <img src="{% static 'admin/images/blank.png' %}" class="wh-40 rounded-3" alt="user">
                                                        {% endif %}
                                                        
                                                        <div class="ms-2 ps-1">
                                                            {{e.nombre_candidato}}
                                                        </div>
                                                    </div>
                                                    
                                                </td>
                                                
                                                <td class="text-body">{{e.nombre_asignado}}</td>
                                                <td class="text-body">
                                                    <span class="badge bg-opacity-10 bg-{{e.obtener_nombre_estado_color.color}} py-1 px-2 text-{{e.obtener_nombre_estado_color.color}} rounded-1 fw-medium fs-12">{{e.obtener_nombre_estado_color.estado}}</span>
                                                </td>

                                                {% comment %} <td>
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        {% if e.candidato_imagen_perfil %}
                                                            <img src="/media_uploads/{{ e.candidato_imagen_perfil}}" class="wh-40 rounded-3" alt="{{ e.candidato_imagen_perfil }}">
                                                        {% else %}
                                                            <img src="{% static 'admin/images/blank.png' %}" class="wh-40 rounded-3" alt="user">
                                                        {% endif %}
                                                        
                                                        <div class="ms-2 ps-1">
                                                            <a href="{% url 'reclutados:reclutados_detalle_cliente' e.id  %}" class="fw-medium">{{e.candidato_nombre}}</a>
                                                        </div>
                                                    </div>
                                                    
                                                </td>
                                                <td class="text-secondary">{{ e.fecha_aplicacion|date:"Y-m-d" }}</td>
                                                <td class="text-secondary">{{ e.fecha_actualizacion|date:"Y-m-d" }}</td>
                                                <td class="text-secondary">{{ e.usuario_asignado_nombre }}</td>
                                                <td>
                                                    <span class="badge bg-opacity-10 bg-{{e.obtener_estado_con_color.color}} py-1 px-2 text-{{e.obtener_estado_con_color.color}} rounded-1 fw-medium fs-12">{{e.obtener_estado_con_color.estado}}</span>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center justify-content-center gap-1">
                                                        <!-- 
                                                        <a href="#" class="ps-0 border-0 bg-transparent lh-1 position-relative top-2">
                                                            <i class="material-symbols-outlined fs-16 text-primary">visibility</i>
                                                        </a>
                                                        -->
                                                        <div class="d-flex justify-content-center align-items-center gap-1" alt="Gestionar" title="Gestionar">
                                                            <a href="{% url 'reclutados:reclutados_detalle_cliente' e.id  %}" class="btn bg-danger bg-opacity-10 fw-medium text-danger py-2 px-4">
                                                                <i class="material-symbols-outlined fs-16 text-danger">manage_accounts</i>
                                                            </a>
                                                        </div>
                                                        
                                                        <!-- 
                                                        <a href="#" class="ps-0 border-0 bg-transparent lh-1 position-relative top-2">
                                                            <i class="material-symbols-outlined fs-16 text-danger">delete</i>
                                                        </a>
                                                        -->
                                                    </div>
                                                </td>  {% endcomment %}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="nav-contact" role="tabpanel" aria-labelledby="nav-contact-tab" tabindex="0">
                        
                            <div class="mb-4">
                                <div class="px-2 pt-2 pb-0">
                                    <span class="fw-semibold text-secondary" style="font-size: 1.05rem;">
                                        <i class="bi bi-question-circle me-1 text-primary"></i>
                                        Preguntas generadas para la vacante
                                    </span>
                                </div>
                                <div class="pt-2 px-2">
                                    {% if preguntas %}
                                        <ul class="ps-0 mb-0" style="list-style: none;">
                                            {% for pregunta in preguntas %}
                                                <li class="d-flex align-items-start mb-2">
                                                    <span class="me-2 mt-1">
                                                        <i class="material-symbols-outlined text-primary">help</i>
                                                    </span>
                                                    <span>{{ pregunta.pregunta }}</span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <div class="alert alert-info mb-0">
                                            No hay preguntas generadas para esta vacante.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="nav-analista" role="tabpanel" aria-labelledby="nav-analista-tab" tabindex="0">
                            <div class="card bg-white border-0 rounded-3 mb-4">
                                <div class="card-body p-4">
                                    <div class="row">
                                        
                                        {% if analista_asignado.id %}
                                        <div class="col-6">
                                            <h3 class="mb-3 fs-16 fw-semibold">Analista Actual</h3>
                                            <div class="vcard p-3 border rounded">
                                                <div class="d-flex align-items-center mb-3">
                                                    
                                                    {% if analista_asignado.imagen_perfil %}
                                                        <img src="{{analista_asignado.imagen_perfil.url}}" alt="Foto del Analista" class="rounded-circle me-3" style="width: 50px; height: 50px;">
                                                    {% else %}
                                                        <img src="{% static 'admin/images/blank.png' %}" alt="Foto del Analista" class="rounded-circle me-3" style="width: 50px; height: 50px;">
                                                    {% endif %}
                                                        
                                                    
                                                    <div> 
                                                        <h5 class="mb-0 fw-bold">{{analista_asignado.primer_nombre}} {{analista_asignado.segundo_nombre}} {{analista_asignado.primer_apellido}} {{analista_asignado.segundo_apellido}}</h5>
                                                        <small class="text-muted">{{analista_asignado.group.name}}</small>
                                                    </div>
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Email:</strong> <a href="mailto:{{analista_asignado.email}}" class="text-decoration-none">{{analista_asignado.email}}</a>
                                                </div>
                                                <a href="{% url 'accesses:users_client_detail' analista_asignado.id %}" class="btn btn-primary py-2 px-4 bg-primary bg-opacity-10 fw-semibold text-primary border-0 hover-bg">
                                                    Ver Perfil Completo
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-6">
                
                                        {% else %}    
                                        <div class="col-12">
                                        {% endif %}
                                            <form method="post" id="form_vacante_asignar">
                                                {% csrf_token %}
                                                {% crispy form %}
                                                <button id="form_vacante_asignar" name="submit_analista" type="submit" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100" form="form_vacante_asignar">Guardar</button>
                                            </form>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                <div>
            </div>
		</div>
	</div>

</div>

<!-- Modal Perfil Completo de la Vacante -->
<div class="modal fade" id="perfilVacanteModal" tabindex="-1" aria-labelledby="perfilVacanteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="perfilVacanteModalLabel">
                    <i class="bi bi-building me-2"></i>Información Completa del Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Información del Cliente -->
                <div class="row">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success"><i class="bi bi-building me-2"></i>Información del Cliente</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">Razón Social</small>
                                        <p class="mb-2 fw-semibold">{{ data.cliente.razon_social }}</p>
                                        
                                        <small class="text-muted">Contacto</small>
                                        <p class="mb-2 fw-semibold">{{ data.cliente.contacto }}</p>
                                        
                                        <small class="text-muted">Email</small>
                                        <p class="mb-2 fw-semibold">{{ data.cliente.email }}</p>
                                        
                                        <small class="text-muted">Teléfono</small>
                                        <p class="mb-2 fw-semibold">{{ data.cliente.telefono }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Ciudad</small>
                                        <p class="mb-2 fw-semibold">{{ data.cliente.ciudad }}</p>
                                        
                                        <small class="text-muted">Tipo de Cliente</small>
                                        <p class="mb-2 fw-semibold">{{ data.cliente.tipo_cliente }}</p>
                                        
                                        <small class="text-muted">Actividad Económica</small>
                                        <p class="mb-2 fw-semibold">{{ data.cliente.actividad_economica }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Perfil Empresarial -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-primary bg-opacity-10">
                                <h6 class="mb-0 text-primary"><i class="bi bi-file-text me-2"></i>Perfil Empresarial</h6>
                            </div>
                            <div class="card-body">
                                {% if data.cliente.perfil_empresarial %}
                                    <p class="mb-0">{{ data.cliente.perfil_empresarial }}</p>
                                {% else %}
                                    <p class="text-muted mb-0">No hay perfil empresarial disponible para este cliente.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block js %} 
<script>

{% if form.errors %}
    var myModal = new bootstrap.Modal(document.getElementById('perfilVacanteModal'));
    myModal.show();
{% endif %}


initializeSelect2('#id_analista_asignado');



$(document).ready(function () {
        const inputDocumento = $('#id_numero_documento');
        const apiUrl = "{% url 'reclutados:api_canidate_document' %}";

        inputDocumento.on('blur', function () {
            const numeroDocumento = $(this).val().trim();

            if (numeroDocumento.length > 0) {
                $.ajax({
                    url: apiUrl,
                    method: 'POST',
                    data: {
                        numero_documento: numeroDocumento,
                        vacante_id: '{{ vacante.id }}',
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (data) {
                        if (data.status == 'error') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonText: 'Aceptar'
                            });
                            
                            // Limpiar los campos si hay error
                            $('#id_primer_nombre').val('');
                            $('#id_segundo_nombre').val('');
                            $('#id_primer_apellido').val('');
                            $('#id_segundo_apellido').val('');
                            $('#id_email').val('');
                            $('#id_telefono').val('');
                            return;
                        }

                        // Llenar campos
                        $('#id_primer_nombre').val(data.primer_nombre || '');
                        $('#id_segundo_nombre').val(data.segundo_nombre || '');
                        $('#id_primer_apellido').val(data.primer_apellido || '');
                        $('#id_segundo_apellido').val(data.segundo_apellido || '');
                        $('#id_email').val(data.email || '');
                        $('#id_telefono').val(data.telefono || '');
                    },
                    error: function (xhr, status, error) {
                        console.error('Error al buscar candidato:', error);
                        /*
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al buscar candidato.',
                            confirmButtonText: 'Aceptar'
                        });
                        */
                        
                        // Limpiar los campos si hay error
                        $('#id_primer_nombre').val('');
                        $('#id_segundo_nombre').val('');
                        $('#id_primer_apellido').val('');
                        $('#id_segundo_apellido').val('');
                        $('#id_email').val('');
                        $('#id_telefono').val('');
                    }
                });
            }
        });
    });

</script>  
{% endblock js %}
{% extends 'admin/layout/dashboard_base.html' %} 

{% load static %}
{% load crispy_forms_tags %}

{% block title %}
Inicio | Dashboard
{% endblock %}

{% block styles %}
<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .loading-spinner {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    .cursor-pointer {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .cursor-pointer:hover {
        transform: translateY(-2px);
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content-container overflow-hidden">
	<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
		<h3 class="mb-0">
			Bienvenido(a), <span class="text-primary">{{ request.session.user_login.primer_nombre }}</span>
        </h3>
		<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
			<ol class="breadcrumb align-items-center mb-0 lh-1">
				<li class="breadcrumb-item">
					<a href="{% url 'accesses:inicio' %}" class="d-flex align-items-center text-decoration-none">
						<i class="ri-home-4-line fs-18 text-primary me-1"></i>
						<span class="text-secondary fw-medium hover" >Inicio</span>
					</a>
				</li>
				
			</ol>
		</nav>
	</div>

	<!-- Start Your Code -->
	<div class="main-content-container overflow-hidden">

		{% if data_candidate.porcentaje_total > 90 %}
		<div class="row">

            <!-- Apartado de Estadísticas Compacto -->
            <div class="col-md-12">
                <div class="card bg-white border-0 rounded-3 mb-4">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <!-- Total de Resultados -->
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h2 class="mb-0 text-primary fw-bold" id="total-resultados">0</h2>
                                    <small class="text-muted">Total Resultados</small>
                                </div>
                            </div>
                            
                            <!-- Separador -->
                            <div class="col-md-1">
                                <div class="vr" style="height: 50px;"></div>
                            </div>
                            
                            <!-- Estadísticas por Ciudad -->
                            <div class="col-md-2 text-center">
                                <div class="cursor-pointer" onclick="showStatsModal('ciudad')">
                                    <h4 class="mb-0 text-primary fw-bold" id="total-ciudad">0</h4>
                                    <small class="text-muted">Ciudades</small>
                                    <div class="mt-1">
                                        <small class="text-primary">Ver detalles <i class="ri-arrow-right-s-line"></i></small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Separador -->
                            <div class="col-md-1">
                                <div class="vr" style="height: 50px;"></div>
                            </div>
                            
                            <!-- Estadísticas por Profesión -->
                            <div class="col-md-2 text-center">
                                <div class="cursor-pointer" onclick="showStatsModal('profesion')">
                                    <h4 class="mb-0 text-success fw-bold" id="total-profesion">0</h4>
                                    <small class="text-muted">Profesiones</small>
                                    <div class="mt-1">
                                        <small class="text-success">Ver detalles <i class="ri-arrow-right-s-line"></i></small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Separador -->
                            <div class="col-md-1">
                                <div class="vr" style="height: 50px;"></div>
                            </div>
                            
                            <!-- Estadísticas por Experiencia -->
                            <div class="col-md-2 text-center">
                                <div class="cursor-pointer" onclick="showStatsModal('experiencia')">
                                    <h4 class="mb-0 text-warning fw-bold" id="total-experiencia">0</h4>
                                    <small class="text-muted">Niveles Exp.</small>
                                    <div class="mt-1">
                                        <small class="text-warning">Ver detalles <i class="ri-arrow-right-s-line"></i></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <div class="col-md-12">
				<div class="card bg-white border-0 rounded-3 mb-4">
                    <form method="get">
                        <div class="card-body p-4">
                            <div class="container">
                                <div class="row mb-4">
                                    <div class="col-md-12">
                                        <h4 style="color: #B10022">VACANTES ABIERTAS</h4>
                                    </div>
                                    <div class="col-md-12">
                                            {% crispy form %}
                                            <div style="text-align: center;">
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <button type="submit" id="form_filtros" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100">Filtrar</button>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <a href="{% url 'vacantes:vacante_candidato_disponibles' %}" class="btn bg-secondary bg-opacity-10 fw-medium text-secondary py-2 px-4 w-100">Limpiar</a>
                                                    </div>
                                                </div>
                                            </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
				</div>	
			</div>
            
            
            <!-- Lista de Vacantes -->
            <div class="col-md-12">
				<div class="card bg-white border-0 rounded-3 mb-4">
					<div class="card-body p-4">
						<div class="container">
							<div class="row mb-4">
								<div class="col-md-12">
									<h4 style="color: #B10022">Vacantes Disponibles en:</h4>
								</div>
							</div>

							<div class="row row-cols-1 g-4">
								{% if vacantes_disponibles %}								
                                    {% for vacante in vacantes_disponibles %}
                                    <div class="col">
                                        <div class="job-card d-flex align-items-center border rounded border-primary border-opacity-25 px-3 py-2">
                                            <div class="row w-100">
                                                <div class="col-md-2 d-flex flex-column align-items-center justify-content-center">
                                                    {% if vacante.asignacion_cliente_id_064.id_cliente_asignado.logo %}
                                                        <img src="{{ vacante.asignacion_cliente_id_064.id_cliente_asignado.logo.url }}" alt="Logo Cliente" class="img-fluid rounded-circle mb-4" style="width: 80px; height: 80px; object-fit: cover;">
                                                    {% else %}
                                                        <img src="{% static 'admin/images/blank.png' %}" alt="Logo por defecto" class="img-fluid rounded-circle mb-2" style="width: 60px; height: 60px; object-fit: cover;">
                                                    {% endif %}
                                                    <a href="{% url 'reclutados:reclutados_confirmar_aplicar_candidato' vacante.id %}" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100">DETALLES</a>
                                                </div>
                                                <div class="col-md-10">
                                                    <h5 class="job-title">{{ vacante.titulo|upper }}</h5>
                                                    <p class="job-meta"><b>{{ vacante.asignacion_cliente_id_064.id_cliente_asignado.razon_social }}</b>. - Hace {{ vacante.fecha_creacion|timesince }}</p>
                                                    <p class="job-meta">{{vacante.perfil_vacante.lugar_trabajo.nombre}}</p>
                                                    <p class="job-description">{{ vacante.descripcion_vacante }}</p>
                                                    <p class="job-description"></p>

                                                    <div class="job-tags">
                                                        {% if vacante.soft_skills_id_053.all %}
                                                            {% for skill in vacante.soft_skills_id_053.all %}
                                                                <span class="badge bg-opacity-10 bg-primary py-1 px-2 text-primary rounded-1 fw-medium fs-12">{{skill.nombre}}</span>
                                                            {% endfor %}
                                                        {% endif %}

                                                        {% if vacante.hard_skills_id_054.all %}
                                                            {% for skill in vacante.hard_skills_id_054.all %}
                                                                <span class="badge bg-opacity-10 bg-primary py-1 px-2 text-primary rounded-1 fw-medium fs-12">{{skill.nombre}}</span>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}

								{% else %}
									<p>No hay vacantes disponibles.</p>
								{% endif %}
							</div>
						</div>
					</div>
				</div>	
			</div>
		{% endif %}
		<hr class="my-4">
	</div>

	
	
</div>
{% endblock %}

{% block js %}
<script>
    initializeSelect2('#id_ciudad');
    initializeSelect2('#id_profesion_estudio');
    initializeSelect2('#id_experiencia_requerida');
</script>

<!-- Modal de Carga -->
<div id="loadingModal" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 mb-0">Actualizando filtros...</p>
    </div>
</div>

<!-- Modal de Detalles de Estadísticas -->
<div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statsModalLabel">
                    <i class="ri-bar-chart-line me-2"></i>
                    Detalles de Estadísticas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-stats-content">
                    <!-- El contenido se llenará dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Función para mostrar/ocultar modal de carga
    function showLoading() {
        $('#loadingModal').show();
    }
    
    function hideLoading() {
        $('#loadingModal').hide();
    }
    
    // Función para actualizar opciones de un select
    function updateSelectOptions(selectId, options) {
        const $select = $(selectId);
        const currentValue = $select.val();
        
        // Limpiar opciones actuales
        $select.empty();
        
        // Agregar nuevas opciones
        options.forEach(function(option) {
            $select.append(new Option(option[1], option[0]));
        });
        
        // Restaurar valor seleccionado si existe
        if (currentValue && $select.find('option[value="' + currentValue + '"]').length > 0) {
            $select.val(currentValue);
        }
        
        // Reinicializar Select2
        $select.select2('destroy');
        initializeSelect2(selectId);
    }
    
    // Función para actualizar filtros dinámicamente
    function updateFilters() {
        showLoading();
        
        const ciudad = $('#id_ciudad').val() || '';
        const profesion = $('#id_profesion_estudio').val() || '';
        const experiencia = $('#id_experiencia_requerida').val() || '';
        const palabras_clave = $('#id_palabras_clave').val() || '';
        
        $.ajax({
            url: '{% url "vacantes:vacante_filtros_opciones" %}',
            type: 'GET',
            data: {
                'ciudad': ciudad,
                'profesion_estudio': profesion,
                'experiencia_requerida': experiencia,
                'palabras_clave': palabras_clave
            },
            success: function(response) {
                // Actualizar opciones de cada select
                updateSelectOptions('#id_ciudad', response.ciudad_options);
                updateSelectOptions('#id_profesion_estudio', response.profesion_options);
                updateSelectOptions('#id_experiencia_requerida', response.experiencia_options);
                
                hideLoading();
            },
            error: function() {
                hideLoading();
                console.error('Error al actualizar filtros');
            }
        });
    }
    
    // Event listeners para cambios en los selects
    $('#id_ciudad').on('change', function() {
        updateFilters();
    });
    
    $('#id_profesion_estudio').on('change', function() {
        updateFilters();
    });
    
    $('#id_experiencia_requerida').on('change', function() {
        updateFilters();
    });
    
    // Función para cargar estadísticas
    function loadStats() {
        const ciudad = $('#id_ciudad').val() || '';
        const profesion = $('#id_profesion_estudio').val() || '';
        const experiencia = $('#id_experiencia_requerida').val() || '';
        const palabras_clave = $('#id_palabras_clave').val() || '';
        
        $.ajax({
            url: '{% url "vacantes:vacante_filtros_estadisticas" %}',
            type: 'GET',
            data: {
                'ciudad': ciudad,
                'profesion_estudio': profesion,
                'experiencia_requerida': experiencia,
                'palabras_clave': palabras_clave
            },
            success: function(response) {
                // Actualizar total de resultados
                $('#total-resultados').text(response.total_resultados);
                
                // Actualizar totales para cada categoría
                $('#total-ciudad').text(Object.keys(response.stats_ciudad).length);
                $('#total-profesion').text(Object.keys(response.stats_profesion).length);
                $('#total-experiencia').text(Object.keys(response.stats_experiencia).length);
                
                // Guardar datos para el modal
                window.currentStats = response;
            },
            error: function() {
                console.error('Error al cargar estadísticas');
            }
        });
    }
    
    // Cargar estadísticas iniciales
    loadStats();
    
    // Cargar estadísticas cuando cambien los filtros
    $('#id_ciudad, #id_profesion_estudio, #id_experiencia_requerida').on('change', function() {
        loadStats();
    });
    
    // Event listener para palabras clave con debounce
    let searchTimeout;
    $('#id_palabras_clave').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            updateFilters();
            loadStats();
        }, 500); // Esperar 500ms después de que el usuario deje de escribir
    });
});

// Función para mostrar modal con detalles de estadísticas
function showStatsModal(type) {
    if (!window.currentStats) {
        alert('No hay datos disponibles');
        return;
    }
    
    let title = '';
    let icon = '';
    let color = '';
    let data = {};
    
    switch(type) {
        case 'ciudad':
            title = 'Detalles por Ciudad';
            icon = 'ri-map-pin-line';
            color = 'primary';
            data = window.currentStats.stats_ciudad;
            break;
        case 'profesion':
            title = 'Detalles por Profesión';
            icon = 'ri-briefcase-line';
            color = 'success';
            data = window.currentStats.stats_profesion;
            break;
        case 'experiencia':
            title = 'Detalles por Experiencia';
            icon = 'ri-time-line';
            color = 'warning';
            data = window.currentStats.stats_experiencia;
            break;
    }
    
    // Actualizar título del modal
    $('#statsModalLabel').html(`<i class="${icon} me-2"></i>${title}`);
    
    // Generar contenido del modal
    let content = '';
    if (Object.keys(data).length > 0) {
        content = '<div class="row">';
        for (const [key, value] of Object.entries(data)) {
            content += `
                <div class="col-md-6 mb-3">
                    <div class="card border-0 bg-light">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${key}</h6>
                                    <small class="text-muted">${value} ${value === 1 ? 'vacante' : 'vacantes'}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${color} fs-6">${value}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        content += '</div>';
    } else {
        content = '<div class="text-center py-4"><p class="text-muted">No hay datos disponibles</p></div>';
    }
    
    $('#modal-stats-content').html(content);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('statsModal'));
    modal.show();
}
</script>

{% endblock %}

{% load static %}
<script>
    window.PROFESIONES_API_URL = "{% url 'vacantes:profesiones_whitelist' %}";

    console.log(window.PROFESIONES_API_URL);

$(document).ready(function() {

    // Otro motivo vacante
    function toggleOtroMotivo() {
        const valorMotivo = $('#id_motivo_vacante').val();

        // Solo mostrar cuando el valor sea específicamente 'OT'
        if (valorMotivo === 'OT') {
            $('#id_otro_motivo').show();
        } else {
            $('#id_otro_motivo').hide();
            $('#id_otro_motivo').val('');
        }
    }

    $('#id_motivo_vacante').on('change', toggleOtroMotivo);
    toggleOtroMotivo();  // Ejecutar al cargar la página
    
    // Validación del formulario antes de enviar
    $('form').on('submit', function(e) {
        let isValid = true;
        
        // Validar tipo de horario
        if (!validarTipoHorario()) {
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            // Hacer scroll al primer campo con error
            $('.is-invalid').first().focus();
        }
    });

    // Motivadores Candidato - Selección múltiple con máximo 2
    function validarMaximoMotivadores() {
        const valoresMotivador = $('#id_motivadores_candidato').val();
        
        if (Array.isArray(valoresMotivador) && valoresMotivador.length > 2) {
            // Remover la última selección
            const valoresValidos = valoresMotivador.slice(0, 2);
            $('#id_motivadores_candidato').val(valoresValidos).trigger('change');
            
            // Mostrar mensaje de advertencia
            if (typeof toastr !== 'undefined') {
                toastr.warning('Solo puede seleccionar máximo 2 motivadores');
            } else {
                alert('Solo puede seleccionar máximo 2 motivadores');
            }
        }
    }

    $('#id_motivadores_candidato').on('change', function() {
        validarMaximoMotivadores();
    });

    // Función para mostrar/ocultar campos según el tipo seleccionado
    function toggleCamposProfesion() {
        const tipoSeleccionado = $('#id_tipo_profesion').val();
        
        // Ocultar todos los campos
        $('#campo_especifica, #campo_grupo, #campo_listado').hide();
        
        // Mostrar solo el campo correspondiente
        switch(tipoSeleccionado) {
            case 'E':
                $('#campo_especifica').show();
                break;
            case 'G':
                $('#campo_grupo').show();
                break;
            case 'L':
                $('#campo_listado').show();
                break;
        }
    }

    // Event listener para el cambio de tipo
    $('#id_tipo_profesion').on('change', function() {
        toggleCamposProfesion();
        
        const tipoSeleccionado = $(this).val();
        
        // Limpiar campos no seleccionados
        if (tipoSeleccionado !== 'E') {
            $('#id_profesion_estudio').val('').trigger('change');
        }
        if (tipoSeleccionado !== 'G') {
            $('#id_grupo_profesion').val('').trigger('change');
        }
        if (tipoSeleccionado !== 'L') {
            $('#id_profesion_estudio_listado').val('');
            // Limpiar Tagify cuando se cambia a otro tipo
            limpiarTagify('id_profesion_estudio_listado');
        }
        
        // Inicializar Tagify solo cuando se selecciona "listado"
        if (tipoSeleccionado === 'L') {
            setTimeout(function() {
                // Limpiar antes de aplicar
                limpiarTagify('id_profesion_estudio_listado');
                // Aplicar Tagify
                TagifyList('id_profesion_estudio_listado', window.PROFESIONES_API_URL);
            }, 100);
        }
    });

    // Inicializar al cargar la página
    toggleCamposProfesion();
    
    // Inicializar Tagify con datos existentes si el tipo es "L" y hay datos
    const tipoProfesion = $('#id_tipo_profesion').val();
    const profesionListado = $('#id_profesion_estudio_listado').val();
    
    if (tipoProfesion === 'L' && profesionListado) {
        setTimeout(function() {
            // Limpiar antes de aplicar
            limpiarTagify('id_profesion_estudio_listado');
            // Aplicar Tagify
            TagifyList('id_profesion_estudio_listado', window.PROFESIONES_API_URL);
            
            // Cargar los datos existentes en Tagify
            try {
                const datosExistentes = JSON.parse(profesionListado);
                if (Array.isArray(datosExistentes)) {
                    const input = document.getElementById('id_profesion_estudio_listado');
                    if (input && input.tagify) {
                        // Extraer solo los valores para mostrar
                        const valores = datosExistentes.map(item => item.value || item);
                        input.tagify.addTags(valores);
                    }
                }
            } catch (e) {
                console.warn('Error parsing existing data:', e);
            }
        }, 200);
    }

    // ===== LÓGICA DE HORARIOS DINÁMICOS =====
    
    // Función para mostrar/ocultar bloques según tipo de horario
    function toggleBloquesHorarios() {
        const tipoHorario = $('#id_tipo_horario').val();
        
        // Ocultar todos los bloques por defecto
        $('#bloque_1, #bloque_2, #bloque_3, #boton_bloque_3').addClass('d-none');
        
        if (tipoHorario === 'HF') {
            // Horario Fijo: Solo mostrar Bloque 1
            $('#bloque_1').removeClass('d-none');
        } else if (tipoHorario === 'HR' || tipoHorario === 'HX') {
            // Horario Rotativo/Flexible: Mostrar Bloques 1 y 2, y botón para Bloque 3
            $('#bloque_1, #bloque_2, #boton_bloque_3').removeClass('d-none');
        }
    }

    // Función para validar tipo de horario
    function validarTipoHorario() {
        const tipoHorario = $('#id_tipo_horario').val();
        const errorElement = $('#id_tipo_horario').closest('.form-group').find('.invalid-feedback');
        
        if (!tipoHorario || tipoHorario === '') {
            if (errorElement.length === 0) {
                $('#id_tipo_horario').addClass('is-invalid');
                $('#id_tipo_horario').after('<div class="invalid-feedback">El campo Tipo de horario es obligatorio.</div>');
            }
            return false;
        } else {
            $('#id_tipo_horario').removeClass('is-invalid');
            $('#id_tipo_horario').closest('.form-group').find('.invalid-feedback').remove();
            return true;
        }
    }

    // Event listener para cambio de tipo de horario
    $('#id_tipo_horario').on('change', function() {
        toggleBloquesHorarios();
        validarTipoHorario(); // Validar cuando cambie
        
        // Limpiar campos de bloques no visibles
        const tipoHorario = $(this).val();
        if (tipoHorario !== 'HF') {
            // Si no es horario fijo, limpiar bloque 3 si está oculto
            if ($('#bloque_3').hasClass('d-none')) {
                $('#id_horario_inicio_3, #id_horario_final_3, #id_hora_inicio_3, #id_hora_final_3').val('');
            }
        }
        if (tipoHorario !== 'HR' && tipoHorario !== 'HX') {
            // Si no es rotativo/flexible, limpiar bloques 2 y 3
            $('#id_horario_inicio_2, #id_horario_final_2, #id_hora_inicio_2, #id_hora_final_2').val('');
            $('#id_horario_inicio_3, #id_horario_final_3, #id_hora_inicio_3, #id_hora_final_3').val('');
        }
    });

    // Event listener para botón "Agregar Bloque 3"
    $('#agregar_bloque_3').on('click', function() {
        $('#bloque_3').removeClass('d-none');
        $('#boton_bloque_3').addClass('d-none');
    });

    // Inicializar al cargar la página
    toggleBloquesHorarios();
    
    // Si hay datos de horarios cargados (modo edición), mostrar los bloques correspondientes
    const tipoHorarioCargado = $('#id_tipo_horario').val();
    if (tipoHorarioCargado) {
        // Verificar si hay datos en los bloques para mostrar el Bloque 3 si es necesario
        if (tipoHorarioCargado === 'HR' || tipoHorarioCargado === 'HX') {
            const hayDatosBloque3 = $('#id_horario_inicio_3').val() || $('#id_horario_final_3').val() || 
                                   $('#id_hora_inicio_3').val() || $('#id_hora_final_3').val();
            if (hayDatosBloque3) {
                $('#bloque_3').removeClass('d-none');
                $('#boton_bloque_3').addClass('d-none');
            }
        }
    }
});

    

// Initialize select2 for specific fields
initializeSelect2('#id_cargo');
initializeSelect2('#id_edad');
initializeSelect2('#id_genero');
initializeSelect2('#id_tiempo_experiencia');
initializeSelect2('#id_modalidad');
initializeSelect2('#id_jornada');
initializeSelect2('#id_tipo_salario');
initializeSelect2('#id_nivel_estudio');
initializeSelect2('#id_lugar_trabajo');
initializeSelect2('#id_termino_contrato');
initializeSelect2('#id_profesion_estudio');
initializeSelect2('#id_frecuencia_pago');
initializeSelect2('#id_nivel_idioma');
initializeSelect2('#id_motivo_vacante');
// Inicializar Select2 para motivadores con selección múltiple
$('#id_motivadores_candidato').select2({
    placeholder: 'Seleccione máximo 2 opciones',
    allowClear: true,
    maximumSelectionLength: 2,
    width: '100%',
    language: {
        maximumSelected: function (e) {
            return "Solo puede seleccionar máximo " + e.maximum + " opciones";
        }
    }
}).on('select2:open select2:close', function() {
    // Asegurar ancho y altura correctos después de abrir/cerrar
    $('.motivadores-field-wrapper .select2-container').css({
        'width': '100%',
        'min-height': '38px'
    });
    $('.motivadores-field-wrapper .select2-selection').css({
        'width': '100%',
        'min-height': '38px'
    });
});

initializeSelect2('#id_estudios_complementarios_certificado_1');
initializeSelect2('#id_estudios_complementarios_certificado_2');
initializeSelect2('#id_estudios_complementarios_certificado_3');
initializeSelect2('#id_numero_posiciones');
initializeSelect2('#id_cantidad_presentar');
initializeSelect2('#id_estado_estudio');
initializeSelect2('#id_idioma');
initializeSelect2('#id_edad_inicial');
initializeSelect2('#id_edad_final');
initializeSelect2('#id_idioma_1');
initializeSelect2('#id_idioma_2');
initializeSelect2('#id_nivel_idioma_1');
initializeSelect2('#id_nivel_idioma_2');


initializeSelect2('#id_tiempo_experiencia_1');
initializeSelect2('#id_tiempo_experiencia_2');
initializeSelect2('#id_tiempo_experiencia_3');

initializeSelect2('#id_tipo_horario');
initializeSelect2('#id_horario_final_1');
initializeSelect2('#id_horario_inicio_1');
initializeSelect2('#id_horario_final_2');
initializeSelect2('#id_horario_inicio_2');
initializeSelect2('#id_horario_final_3');
initializeSelect2('#id_horario_inicio_3');

initializeSelect2('#id_tipo_profesion');
initializeSelect2('#id_profesion_estudio');
initializeSelect2('#id_grupo_profesion');

// Lista personalizada para el campo 2
document.addEventListener('DOMContentLoaded', function() {
    // Ubicamos el campo de texto de destino por su ID
    const targetTextarea = document.getElementById('id_descripcion_vacante');

    // Si el campo existe, le añadimos un "oyente" para el evento 'focus'.
    // 'focus' se dispara en el momento exacto en que el usuario hace clic en el campo.
    if (targetTextarea) {
        targetTextarea.addEventListener('focus', generateVacancyParagraph);
    }

    /**
        * Función auxiliar para obtener el valor de un campo de forma segura.
        */
    function getFieldValue(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return '';
        if (element.tagName === 'SELECT' && element.selectedIndex > 0) {
            return element.options[element.selectedIndex].text;
        }
        return element.value.trim();
    }

    /**
        * Función auxiliar para obtener los valores de un campo de selección múltiple.
        */
    function getMultiSelectValues(elementId) {
        const selectElement = document.getElementById(elementId);
        if (!selectElement) return [];
        return Array.from(selectElement.selectedOptions).map(option => option.text);
    }

    /**
        * Función para unir elementos de una lista en un texto gramaticalmente correcto.
        * Ejemplo: ['A', 'B', 'C'] se convierte en "A, B y C".
        */
    function formatListToText(items) {
        if (items.length === 0) return '';
        if (items.length === 1) return items[0];
        if (items.length === 2) return items.join(' y ');
        return items.slice(0, -1).join(', ') + ' y ' + items.slice(-1);
    }

    /**
        * Función principal que se ejecuta al hacer clic (focus) en el campo.
        * Redacta el párrafo de la descripción de la vacante.
        */
    function generateVacancyParagraph() {
        // --- 1. Recopilar todos los datos del formulario ---
        const cargo = getFieldValue('id_cargo');
        const modalidad = getFieldValue('id_modalidad');
        const lugar_trabajo = getFieldValue('id_lugar_trabajo');
        const termino_contrato = getFieldValue('id_termino_contrato');
        const salario = getFieldValue('id_salario');
        const tipo_salario = getFieldValue('id_tipo_salario');
        const profesion = getFieldValue('id_profesion_estudio');
        const nivelEstudio = getFieldValue('id_nivel_estudio');
        const tiempoExp1 = getFieldValue('id_tiempo_experiencia_1');
        const exp1 = getFieldValue('id_experiencia_especifica_en_1');
        const idioma1 = getFieldValue('id_idioma_1');
        const nivelIdioma1 = getFieldValue('id_nivel_idioma_1');

        const funciones = [
            getFieldValue('id_funciones_responsabilidades_1'),
            getFieldValue('id_funciones_responsabilidades_2'),
            getFieldValue('id_funciones_responsabilidades_3')
        ].filter(Boolean).map(f => f && typeof f === 'string' ? f.toLowerCase() : f);

        const allSkills = [
            getMultiSelectValues('id_skill_relacionales'),
            getMultiSelectValues('id_skill_personales'),
            getMultiSelectValues('id_skill_cognitivas'),
            getMultiSelectValues('id_skill_digitales'),
            getMultiSelectValues('id_skill_liderazgo')
        ].map(s => s && typeof s === 'string' ? s.toLowerCase() : s);

        // --- 2. Construir el párrafo oración por oración ---
        const sentences = [];

        if (cargo) {
            sentences.push(`Nos encontramos en la búsqueda de un(a) ${cargo} para unirse a nuestro equipo.`);
        }

        let roleDetails = [];
        if (lugar_trabajo) roleDetails.push(`en ${lugar_trabajo}`);
        if (modalidad) roleDetails.push(`bajo una modalidad ${modalidad && typeof modalidad === 'string' ? modalidad.toLowerCase() : modalidad}`);
        if (termino_contrato) roleDetails.push(`con un contrato a término ${termino_contrato && typeof termino_contrato === 'string' ? termino_contrato.toLowerCase() : termino_contrato}`);
        if (roleDetails.length > 0) {
            sentences.push(`La posición se desarrollará ${roleDetails.join(', ')}.`);
        }

        if (funciones.length > 0) {
            sentences.push(`Dentro de sus principales responsabilidades se encontrarán ${formatListToText(funciones)}.`);
        }

        let requirements = [];
        if (profesion && nivelEstudio) {
            requirements.push(`formación como ${nivelEstudio} en ${profesion}`);
        }
        if (exp1 && tiempoExp1) {
            requirements.push(`una experiencia mínima de ${tiempoExp1} en ${exp1}`);
        }
        if (idioma1 && nivelIdioma1) {
            requirements.push(`dominio del idioma ${idioma1} a un nivel ${nivelIdioma1 && typeof nivelIdioma1 === 'string' ? nivelIdioma1.toLowerCase() : nivelIdioma1}`);
        }
        if (requirements.length > 0) {
            sentences.push(`Para esta vacante, el perfil ideal deberá contar con ${formatListToText(requirements)}.`);
        }

        if (allSkills.length > 0) {
            sentences.push(`Adicionalmente, valoramos un alto desarrollo de competencias como ${formatListToText(allSkills)}.`);
        }
        
        if (salario) {
            const tipoSalarioText = tipo_salario && typeof tipo_salario === 'string' ? tipo_salario.toLowerCase() : '';
            sentences.push(`La oferta salarial para este cargo es de $${salario} ${tipoSalarioText}.`);
        }

        // --- 3. Unir las oraciones y mostrar el texto en el campo ---
        targetTextarea.value = sentences.join(' ');
    }
});

// CSS personalizado para el campo de motivadores
$(document).ready(function() {
    // Asegurar que el campo de motivadores tenga el ancho y altura correctos
    $('.motivadores-field-wrapper .select2-container').css({
        'width': '100%',
        'min-height': '38px'
    });
    $('.motivadores-field-wrapper .select2-selection').css({
        'width': '100%',
        'min-height': '38px'
    });
    
    // Re-aplicar después de que Select2 se inicialice
    setTimeout(function() {
        $('.motivadores-field-wrapper .select2-container').css({
            'width': '100%',
            'min-height': '38px'
        });
        $('.motivadores-field-wrapper .select2-selection').css({
            'width': '100%',
            'min-height': '38px'
        });
    }, 100);
});
</script>
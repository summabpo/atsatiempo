{% extends 'admin/layout/dashboard_base.html' %} 

{% load static %}
{% load crispy_forms_tags %}

{% block title %}
Información Básica | Talent Tray
{% endblock %}

{% block styles %}
{% endblock %}

{% block content %}
<div class="main-content-container overflow-hidden">
	<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
		<h3 class="mb-0" style="color: #B10022;">INFORMACIÓN ACADÉMICA</h3>
		<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
			<ol class="breadcrumb align-items-center mb-0 lh-1">
				<li class="breadcrumb-item">
					<a href="{% url 'accesses:inicio' %}" class="d-flex align-items-center text-decoration-none">
						<i class="ri-home-4-line fs-18 text-primary me-1"></i>
						<span class="text-secondary fw-medium hover" >Inicio</span>
					</a>
				</li>
				<li class="breadcrumb-item active" aria-current="page">
					<span class="fw-medium">Información Académica</span>
				</li>
			</ol>
		</nav>
	</div>

	<!-- Panel de información -->
	{% include 'admin/candidate/candidate_user/layout/base_candidate_info_records.html' %}

	<!-- Start Your Code -->
    <div class="row">
		<div class="col-12">
            <div class="card bg-white border-0 rounded-3 mb-4">
				<div class="card-body p-4">
                    <div class="mb-4">
                        <h3 class="mb-0">Listado Estudios</h3>
                    </div>
                    <!-- Button trigger modal -->
                    <div class="d-flex justify-content-between w-100 align-items-center mb-3">
                        <button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4" data-bs-toggle="modal" data-bs-target="#estudios_candidato">
                            Crear Estudio
                        </button>
                        <button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4" data-bs-toggle="modal" data-bs-target="#lineaTiempoAcademicaModal">
                            Línea del Tiempo
                        </button>
                    </div>

                    <!-- Modal -->
                    <div class="modal fade" id="estudios_candidato" tabindex="-1" aria-labelledby="estudios_candidato" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="exampleModalLabel">Crear Estudio</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>

                                <form method="post" id="form_estudio" enctype="multipart/form-data">
                                    <div class="modal-body">
                                        {% csrf_token %}
                                        {% crispy form %}
                                    </div>
                                    <div class="modal-footer">
                                        <button id="form_estudio" type="submit" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100" form="form_estudio">Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="default-table-area all-projects">
                        <div class="table-responsive">
                            <table class="table align-middle text-center" id="myTable">
                                <thead>
                                    <tr>
                                        <th scope="col" class="text-center">INSTITUCIÓN</th>
                                        <th scope="col" class="text-center">FECHA INICIAL</th>
                                        <th scope="col" class="text-center">FECHA FINAL</th>
                                        <th scope="col" class="text-center">GRADO OBTENIDO</th>
                                        <th scope="col" class="text-center">TÍTULO</th>
                                        <th scope="col" class="text-center">CIUDAD</th>
                                        <th scope="col" class="text-center">TIPO DE ESTUDIO</th>
                                        <th scope="col" class="text-center">PROFESIÓN O ESTUDIO</th>
                                        <th scope="col" class="text-center">ESTADO DEL ESTUDIO</th>
                                        <th scope="col" class="text-center">ACCIONES</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for e in studies %}
                                    <tr>
                                        <td class="text-body text-center">{{e.institucion}}</td>
                                        <td class="text-body text-center">{{ e.fecha_inicial|date:"Y-m-d" }}</td>
                                        <td class="text-body text-center">{% if e.fecha_final %}{{ e.fecha_final|date:"Y-m-d" }}{% else %}--{% endif %}</td>
                                        <td class="text-body text-center">{{ e.grado_en|yesno:"Sí,No" }}</td>
                                        <td class="text-body text-center">{% if e.titulo %}{{ e.titulo }}{% else %}--{% endif %}</td>
                                        <td class="text-body text-center">{{ e.ciudad_id_004 }}</td>
                                        <td class="text-body text-center">{{ e.mostrar_tipo_estudio }}</td>
                                        <td class="text-body text-center">{{ e.profesion_estudio.nombre }}</td>
                                        <td class="text-body text-center">{{ e.mostrar_estado_estudios }}</td>
                                        <td class="text-center">
                                            <div class="d-flex justify-content-center align-items-center gap-1">
                                                <div class="d-flex justify-content-center align-items-center gap-1" alt="Gestionar" title="Gestionar">
                                                    <a href="{% url 'candidatos:candidato_info_academica_editar' e.id  %}" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100">
                                                        <i class="material-symbols-outlined fs-16 text-primary">edit</i>
                                                    </a>
                                                </div>
                                                {% if e.certificacion %}
                                                <div class="d-flex justify-content-center align-items-center gap-1" alt="Ver Certificación" title="Ver Certificación">
                                                    <button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary-2 px-4" data-bs-toggle="modal" data-bs-target="#certModal{{ e.id }}">
                                                        <i class="material-symbols-outlined fs-16 text-primary">visibility</i>
                                                    </button>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </td> 

                                        
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modales para ver certificaciones -->
        {% for e in studies %}
            {% if e.certificacion %}
            <div class="modal fade" id="certModal{{ e.id }}" tabindex="-1" aria-labelledby="certModalLabel{{ e.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="certModalLabel{{ e.id }}">Certificación - {{ e.institucion }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" style="min-height: 500px;">
                            {% with filename=e.certificacion.name|lower %}
                                {% if ".pdf" in filename %}
                                    <iframe src="{{ e.certificacion.url }}" style="width: 100%; height: 600px; border: none;"></iframe>
                                {% else %}
                                    <div class="text-center">
                                        <img src="{{ e.certificacion.url }}" alt="Certificación" class="img-fluid" style="max-height: 600px; border: 1px solid #dee2e6; border-radius: 4px;">
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}

        <!-- Modal Línea del Tiempo Académica -->
        <div class="modal fade" id="lineaTiempoAcademicaModal" tabindex="-1" aria-labelledby="lineaTiempoAcademicaModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="lineaTiempoAcademicaModalLabel">Línea del Tiempo de Estudios</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="timeline">
                            {% for educacion in studies %}
                                <div class="position-relative timeline-item dot-3 mb-4">
                                    <span class="time-line-date">{{ educacion.fecha_inicial|date:"Y M" }}</span>
                                    <div class="border-style-for-timeline dot-3">
                                        <h4 class="fs-14 fw-medium mb-2 text-primary">{{ educacion.institucion }}</h4>
                                        <p class="fs-13 mb-1">
                                            {% if educacion.grado_en %}
                                                Grado en: <b>{{ educacion.titulo }} - {{ educacion.carrera }}</b>
                                            {% else %}
                                                Carrera: <b>{{ educacion.carrera }}</b>
                                            {% endif %}
                                        </p>
                                        <p class="fs-13 mb-1">
                                            Fecha Final: {% if educacion.fecha_final %}
                                                <b>{{ educacion.fecha_final|date:"Y M" }}</b>
                                            {% else %}
                                                <b>Actualmente</b>
                                            {% endif %}
                                        </p>
                                        <p class="fs-13 mb-1">
                                            Tipo de Estudio: <b>{{ educacion.get_tipo_estudio_display }}</b>
                                        </p>
                                        <p class="fs-13 mb-1">
                                            Ciudad: <b>{{ educacion.ciudad_id_004.nombre }}</b>
                                        </p>
                                        {% if educacion.certificacion %}
                                        <div class="mt-2">
                                            <button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100" data-bs-toggle="modal" data-bs-target="#certModal{{ educacion.id }}" data-bs-dismiss="modal">
                                                <i class="material-symbols-outlined fs-14 text-primary">visibility</i> Ver Certificación
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-muted">No hay estudios registrados.</p>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %} 
<script>
    // Check if there are form errors and show the modal if true
    {% if form.errors %}
        var myModal = new bootstrap.Modal(document.getElementById('estudios_candidato'));
        myModal.show();
    {% endif %}

    $(document).ready(function () {
        // Función para manejar campos según estado de estudios
        function toggleEstadoEstudiosFields() {
            var estadoEstudios = $('#id_estado_estudios').val();
            var isGraduado = estadoEstudios === 'G';
            var isAplazado = estadoEstudios === 'A';
            var isEnCurso = estadoEstudios === 'C';
            
            // Campos
            var $titulo = $('#div_id_titulo');
            var $fechaInicial = $('#div_id_fecha_inicial');
            var $fechaFinal = $('#div_id_fecha_final');
            var $certificacion = $('#div_id_certificacion');
            
            if (isGraduado) {
                // Si es Graduado: mostrar título, fecha_inicial, fecha_final, certificacion
                $titulo.show();
                $fechaInicial.show();
                $fechaFinal.show();
                $certificacion.show();
                $('#id_titulo').attr('required', 'required');
                $('#id_fecha_inicial').attr('required', 'required');
                $('#id_fecha_final').attr('required', 'required');
            } else if (isAplazado) {
                // Si es Aplazado: ocultar título, ocultar fecha_inicial, mostrar fecha_final, ocultar certificacion
                $titulo.hide();
                $fechaInicial.hide();
                $fechaFinal.show();
                $certificacion.hide();
                $('#id_titulo').removeAttr('required');
                $('#id_fecha_inicial').removeAttr('required');
                $('#id_fecha_final').attr('required', 'required');
                $('#id_titulo').val('');
                $('#id_fecha_inicial').val('');
                $('#id_certificacion').val('');
            } else if (isEnCurso) {
                // Si está En curso: ocultar título, mostrar fecha_inicial, ocultar fecha_final, ocultar certificacion
                $titulo.hide();
                $fechaInicial.show();
                $fechaFinal.hide();
                $certificacion.hide();
                $('#id_titulo').removeAttr('required');
                $('#id_fecha_inicial').attr('required', 'required');
                $('#id_fecha_final').removeAttr('required');
                $('#id_titulo').val('');
                $('#id_fecha_final').val('');
                $('#id_certificacion').val('');
            } else {
                // Si no hay estado seleccionado, ocultar campos de graduado
                $titulo.hide();
                $fechaInicial.show();
                $fechaFinal.hide();
                $certificacion.hide();
                $('#id_titulo').removeAttr('required');
                $('#id_fecha_final').removeAttr('required');
            }
        }
        
        // Función para manejar "Sin estudios"
        function toggleSinEstudiosFields() {
            var tipoEstudio = $('#id_tipo_estudio').val();
            var isSinEstudios = tipoEstudio === '1';
            
            // Campos a ocultar/mostrar cuando es "Sin estudios"
            var camposAfectados = [
                '#div_id_institucion',
                '#div_id_fecha_inicial',
                '#div_id_fecha_final',
                '#div_id_titulo',
                '#div_id_ciudad_id_004',
                '#div_id_profesion_estudio',
                '#div_id_estado_estudios',
                '#div_id_certificacion'
            ];
            
            camposAfectados.forEach(function(selector) {
                var $campo = $(selector);
                if (isSinEstudios) {
                    $campo.hide();
                    // Hacer los campos opcionales
                    var fieldId = selector.replace('#div_id_', 'id_');
                    $('#' + fieldId).removeAttr('required');
                } else {
                    $campo.show();
                    // Restaurar campos requeridos según la definición del formulario
                    var fieldId = selector.replace('#div_id_', 'id_');
                    // No restaurar required aquí, el formulario lo maneja
                }
            });
        }
        
        // Ejecutar al cargar
        toggleSinEstudiosFields();
        toggleEstadoEstudiosFields();
        
        // Ejecutar al cambiar el tipo de estudio
        $('#id_tipo_estudio').on('change', function() {
            toggleSinEstudiosFields();
            // Si no es "Sin estudios", también verificar estado
            if ($(this).val() !== '1') {
                toggleEstadoEstudiosFields();
            }
        });
        
        // Ejecutar al cambiar el estado de estudios
        $('#id_estado_estudios').on('change', toggleEstadoEstudiosFields);
    });

    initializeSelect2('#id_tipo_estudio');
    initializeSelect2('#id_ciudad_id_004');
    initializeSelect2('#id_profesion_estudio');
    initializeSelect2('#id_estado_estudios');
    
</script>
{% endblock js %}
{% extends 'admin/layout/dashboard_base.html' %} 

{% load static %}
{% load crispy_forms_tags %}
{% load custom_tags %}

{% block title %}
Detalle Candidato - Reclutador
{% endblock %}

{% block content %}
<div class="main-content-container overflow-hidden">
	<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
		<div class="d-flex align-items-center gap-3">
			<h3 class="mb-0" style="color: #B10022;">DETALLE CANDIDATO</h3>
			<!-- Botones de navegación -->
			<div class="d-flex gap-2">
				{% if candidato_anterior %}
				<a href="{% url 'reclutados:reclutados_detalle_reclutador' candidato_anterior.id %}" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 d-flex align-items-center" title="Candidato Anterior">
					<i class="ri-arrow-left-line me-2"></i>
					<span>Anterior</span>
				</a>
				{% else %}
				<button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 d-flex align-items-center" disabled title="No hay candidato anterior">
					<i class="ri-arrow-left-line me-2"></i>
					<span>Anterior</span>
				</button>
				{% endif %}
				{% if candidato_siguiente %}
				<a href="{% url 'reclutados:reclutados_detalle_reclutador' candidato_siguiente.id %}" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 d-flex align-items-center" title="Candidato Siguiente">
					<span>Siguiente</span>
					<i class="ri-arrow-right-line ms-2"></i>
				</a>
				{% else %}
				<button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 d-flex align-items-center" disabled title="No hay candidato siguiente">
					<span>Siguiente</span>
					<i class="ri-arrow-right-line ms-2"></i>
				</button>
				{% endif %}
			</div>
		</div>
		<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
			<ol class="breadcrumb align-items-center mb-0 lh-1">
				<li class="breadcrumb-item">
					<a href="{% url 'accesses:inicio' %}" class="d-flex align-items-center text-decoration-none">
						<i class="ri-home-4-line fs-18 text-primary me-1"></i>
						<span class="text-secondary fw-medium hover">Inicio</span>
					</a>
				</li>
				{% if request.session.grupo_id == 3 %}
                    {% if request.session.user_login.cliente_tipo == '1' %}
                    <li class="breadcrumb-item active" aria-current="page">
                        <a href="{% url 'vacantes:vacantes_listado_cliente' %}" class="d-flex align-items-center text-decoration-none">
                            <span class="text-secondary fw-medium hover" >Vacantes Propias</span>
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <a href="{% url 'vacantes:vacantes_gestion_propias' vacante.asignacion_cliente_id_064.id_cliente_asignado.id vacante.id %}" class="d-flex align-items-center text-decoration-none">
                            <span class="text-secondary fw-medium hover" >Gestión Vacante</span>
                        </a>
                    </li>
                    {% endif %}

                    {% if request.session.user_login.cliente_tipo == '2' %}
                    <li class="breadcrumb-item active" aria-current="page">
                        <a href="{% url 'clientes:client_headhunter_asignados' %}" class="d-flex align-items-center text-decoration-none">
                            <span class="text-secondary fw-medium hover" >Clientes Asignados</span>
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <a href="{% url 'vacantes:vacantes_propias' vacante.asignacion_cliente_id_064.id_cliente_asignado.id %}" class="d-flex align-items-center text-decoration-none">
                            <span class="text-secondary fw-medium hover" >Vacantes Cliente</span>
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <a href="{% url 'vacantes:vacantes_gestion_propias' vacante.asignacion_cliente_id_064.id_cliente_asignado.id vacante.id %}" class="d-flex align-items-center text-decoration-none">
                            <span class="text-secondary fw-medium hover" >Gestión Vacante</span>
                        </a>
                    </li>
                    {% endif %}

                    {% if request.session.user_login.cliente_tipo == '3' %}
                    
                    {% endif %}
                    
                {% endif %}
				{% if request.session.grupo_id == 7 %}

				
				<li class="breadcrumb-item active" aria-current="page">
					<a href="{% url 'reclutados:vacantes_asignadas_reclutador' %}" class="d-flex align-items-center text-decoration-none">
						<span class="text-secondary fw-medium hover">Vacantes Asignadas</span>
					</a>
				</li>
				<li class="breadcrumb-item active" aria-current="page">
					<a href="{% url 'reclutados:vacantes_gestion_reclutador' vacante.asignacion_cliente_id_064.id_cliente_asignado.id vacante.id %}" class="d-flex align-items-center text-decoration-none">
						<span class="text-secondary fw-medium hover">Gestión de Vacante</span>
					</a>
				</li>
				{% endif %}
				<li class="breadcrumb-item active" aria-current="page">
					<span class="fw-medium">Detalle Candidato</span>
				</li>
			</ol>
		</nav>
	</div>

	<div class="row">
		<!-- Columna principal con información del candidato -->
		<div class="col-md-9">
			<!-- Card de información básica -->
			<div class="card bg-white border-0 rounded-3 mb-4">
				<div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
					<p class="text-primary my-2 fs-4 fw-semibold">Información del Candidato</p>
				</div>
				<div class="card-body p-4">
					<div class="row">
						<div class="col-4">
							<div class="d-flex align-items-center">
								<div class="flex-shrink-0">
									{% if candidato.imagen_perfil %}
										<img src="{{ candidato.imagen_perfil.url }}" class="rounded-circle border border-2" style="width: 100px; height: 100px; object-fit: cover;" alt="{{ candidato.nombre_completo }}">
									{% else %}
										<img src="{% static 'admin/images/blank.png' %}" class="rounded-circle border border-2" style="width: 100px; height: 100px; object-fit: cover;" alt="user">
									{% endif %}
								</div>
								<div class="flex-grow-1 ms-3">
									<h4 class="fs-17 mb-1 fw-semibold">{{ candidato.nombre_completo }}</h4>
									<span class="fs-14 text-muted">Candidato</span>
								</div>
							</div>
						</div>
						<div class="col-8">
							<div class="row">
								<div class="col-xxl-4 col-lg-6 col-md-4 col-sm-6">
									<div class="d-flex align-items-center mb-4">
										<div class="flex-shrink-0">
											<i class="material-symbols-outlined d-inline-block wh-70 lh-70 text-center fs-35 text-primary bg-gary-light rounded-circle bg-for-dark-mode">schedule</i>
										</div>
										<div class="flex-grow-1 ms-3">
											<h4 class="fs-14 fw-semibold mb-1">Fecha Aplicó</h4>
											<span>{{ reclutado.fecha_aplicacion|date:"d/m/Y" }}</span>
										</div>
									</div>
								</div>
								<div class="col-xxl-4 col-lg-6 col-md-4 col-sm-6">
									<div class="d-flex align-items-center mb-4">
										<div class="flex-shrink-0">
											<i class="material-symbols-outlined d-inline-block wh-70 lh-70 text-center fs-35 text-warning bg-gary-light rounded-circle bg-for-dark-mode">schedule</i>
										</div>
										<div class="flex-grow-1 ms-3">
											<h4 class="fs-14 fw-semibold mb-1">Fecha Actualización</h4>
											<span>{{ reclutado.fecha_actualizacion|date:"d/m/Y" }}</span>
										</div>
									</div>
								</div>
								<div class="col-xxl-4 col-lg-6 col-md-4 col-sm-6">
									<div class="d-flex align-items-center mb-4">
										<div class="flex-shrink-0">
											<i class="material-symbols-outlined d-inline-block wh-70 lh-70 text-center fs-35 text-info bg-gary-light rounded-circle bg-for-dark-mode">person_alert</i>
										</div>
										<div class="flex-grow-1 ms-3">
											<h4 class="fs-14 fw-semibold mb-1">Estado Actual</h4>
											{% if reclutado.estado_reclutamiento == 1 %}
												<span class="badge bg-warning text-dark py-1 px-2 rounded-1 fw-medium fs-12">Recibido</span>
											{% elif reclutado.estado_reclutamiento == 2 %}
												<span class="badge bg-success text-white py-1 px-2 rounded-1 fw-medium fs-12">Seleccionado</span>
											{% elif reclutado.estado_reclutamiento == 3 %}
												<span class="badge bg-primary text-white py-1 px-2 rounded-1 fw-medium fs-12">Finalista</span>
											{% elif reclutado.estado_reclutamiento == 4 %}
												<span class="badge bg-danger text-white py-1 px-2 rounded-1 fw-medium fs-12">Descartado</span>
											{% endif %}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Card de información detallada del candidato -->
			<div class="card bg-white border-0 rounded-3 mb-4">
				<div class="card-body p-4">
					<ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="perfil-tab" data-bs-toggle="tab" data-bs-target="#perfil-tab-pane" type="button" role="tab" aria-controls="perfil-tab-pane" aria-selected="true">Perfil Candidato</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="respuestas-tab" data-bs-toggle="tab" data-bs-target="#respuestas-tab-pane" type="button" role="tab" aria-controls="respuestas-tab-pane" aria-selected="false">Respuestas de Aplicación</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="match-tab" data-bs-toggle="tab" data-bs-target="#match-tab-pane" type="button" role="tab" aria-controls="match-tab-pane" aria-selected="false">Match Candidato Vacante</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="match-inicial-tab" data-bs-toggle="tab" data-bs-target="#match-inicial-tab-pane" type="button" role="tab" aria-controls="match-inicial-tab-pane" aria-selected="false">Match Inicial</button>
						</li>
					</ul>
					<div class="tab-content" id="myTabContent">
						<!-- Tab Perfil -->
						<div class="tab-pane fade show active" id="perfil-tab-pane" role="tabpanel" aria-labelledby="perfil-tab" tabindex="0">
							<div class="row">
								<div class="col-md-4">
									<div class="card bg-white border rounded-3 mb-4">
										<div class="card-body p-4">
											<div class="text-center mb-4">
												{% if candidato.imagen_perfil %}
													<img src="{{ candidato.imagen_perfil.url }}" class="rounded-circle border border-2" style="width: 120px; height: 120px; object-fit: cover; margin-bottom: 1rem;" alt="{{ candidato.nombre_completo }}">
												{% else %}
													<img src="{% static 'admin/images/blank.png' %}" class="rounded-circle border border-2" style="width: 120px; height: 120px; object-fit: cover; margin-bottom: 1rem;" alt="user">
												{% endif %}
												<h4 class="fs-18 mb-1 fw-semibold">{{ candidato.nombre_completo }}</h4>
											</div>
											<h5 class="fs-14 fw-semibold mb-3 text-primary">Información de Contacto</h5>
											{% if candidato.hoja_de_vida %}
											<div class="mb-3">
												<button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100" data-bs-toggle="modal" data-bs-target="#modalHojaVida">
													<i class="material-symbols-outlined me-2" style="vertical-align: middle;">description</i>
													Ver Hoja de Vida
												</button>
											</div>
											{% endif %}
											<ul class="list-unstyled mb-0">
												<li class="d-flex align-items-center mb-3">
													<span class="material-symbols-outlined text-primary me-2">badge</span>
													<div>
														<small class="text-muted d-block">Documento</small>
														<span class="fw-medium">{{ info_detalle_candidato.numero_documento|default:"-" }}</span>
													</div>
												</li>
												<li class="d-flex align-items-center mb-3">
													<span class="material-symbols-outlined text-primary me-2">email</span>
													<div>
														<small class="text-muted d-block">Email</small>
														<span class="fw-medium">{{ info_detalle_candidato.email|default:"-" }}</span>
													</div>
												</li>
												<li class="d-flex align-items-center mb-3">
													<span class="material-symbols-outlined text-primary me-2">phone</span>
													<div>
														<small class="text-muted d-block">Teléfono</small>
														<span class="fw-medium">{{ info_detalle_candidato.telefono|default:"-" }}</span>
													</div>
												</li>
												<li class="d-flex align-items-center mb-3">
													<span class="material-symbols-outlined text-primary me-2">location_on</span>
													<div>
														<small class="text-muted d-block">Ubicación</small>
														<span class="fw-medium">{{ info_detalle_candidato.ciudad|default:"-" }}</span>
													</div>
												</li>
												<li class="d-flex align-items-center mb-3">
													<span class="material-symbols-outlined text-primary me-2">wc</span>
													<div>
														<small class="text-muted d-block">Género</small>
														<span class="fw-medium">{{ info_detalle_candidato.sexo|default:"-" }}</span>
													</div>
												</li>
												<li class="d-flex align-items-center mb-3">
													<span class="material-symbols-outlined text-primary me-2">calendar_month</span>
													<div>
														<small class="text-muted d-block">Fecha Nacimiento</small>
														<span class="fw-medium">{{ info_detalle_candidato.fecha_nacimiento|date:"d/m/Y"|default:"-" }}</span>
													</div>
												</li>
											</ul>
										</div>
									</div>
								</div>
								<div class="col-md-8">
									<!-- Formación Académica -->
									<div class="card bg-white border rounded-3 mb-4">
										<div class="card-body p-4">
											<h5 class="fs-16 fw-semibold mb-3 text-primary">
												<span class="material-symbols-outlined text-primary me-2">school</span>
												Formación Académica
											</h5>
											{% if info_detalle_candidato.educacion %}
												{% for edu in info_detalle_candidato.educacion %}
												<div class="position-relative ps-4 pb-4 mb-3">
													<div class="position-absolute start-0 top-0 h-100" style="width: 2px; background-color: #dee2e6;"></div>
													<div class="position-absolute start-0 top-0" style="width: 14px; height: 14px; background-color: #B10022; border-radius: 50%; transform: translateX(-6px); border: 2px solid #ffffff;"></div>
													<p class="fw-semibold mb-1">{{ edu.institucion }}</p>
													<p class="text-muted mb-1">{{ edu.titulo }} ({{ edu.tipo_estudio }})</p>
													<p class="text-muted small mb-0">{{ edu.fecha_inicial|date:"Y" }} - {{ edu.fecha_final|date:"Y"|default:"Actual" }}</p>
												</div>
												{% endfor %}
											{% else %}
												<p class="text-muted">No se registran estudios.</p>
											{% endif %}
										</div>
									</div>

									<!-- Experiencia Laboral -->
									<div class="card bg-white border rounded-3 mb-4">
										<div class="card-body p-4">
											<h5 class="fs-16 fw-semibold mb-3 text-primary">
												<span class="material-symbols-outlined text-primary me-2">work</span>
												Experiencia Laboral
											</h5>
											{% if info_detalle_candidato.experiencia %}
												{% for exp in info_detalle_candidato.experiencia %}
												<div class="position-relative ps-4 pb-4 mb-3">
													<div class="position-absolute start-0 top-0 h-100" style="width: 2px; background-color: #dee2e6;"></div>
													<div class="position-absolute start-0 top-0" style="width: 14px; height: 14px; background-color: #B10022; border-radius: 50%; transform: translateX(-6px); border: 2px solid #ffffff;"></div>
													<p class="fw-semibold mb-1">{{ exp.entidad }} ({{ exp.sector }})</p>
													<p class="text-muted mb-1">{{ exp.cargo }}</p>
													<p class="text-muted small mb-0">{{ exp.fecha_inicial|date:"Y" }} - {{ exp.fecha_final|date:"Y"|default:"Actual" }}</p>
												</div>
												{% endfor %}
											{% else %}
												<p class="text-muted">No se registra experiencia laboral.</p>
											{% endif %}
										</div>
									</div>
								</div>
							</div>
						</div>
						<!-- Tab Respuestas de Aplicación -->
						<div class="tab-pane fade" id="respuestas-tab-pane" role="tabpanel" aria-labelledby="respuestas-tab" tabindex="0">
							{% if preguntas_reclutamiento %}
								<div class="card bg-white border rounded-3 mb-4">
									<div class="card-body p-4">
										<h5 class="fs-16 fw-semibold mb-4 text-primary">
											<span class="material-symbols-outlined text-primary me-2">quiz</span>
											Respuestas del Candidato
										</h5>
										<div class="row">
											{% for pregunta_texto, respuesta in preguntas_reclutamiento.items %}
											<div class="col-md-12 mb-4">
												<div class="card border rounded-3">
													<div class="card-body p-3">
														<div class="d-flex justify-content-between align-items-start">
															<div class="flex-grow-1">
																<h6 class="fw-semibold mb-2 text-dark">{{ pregunta_texto }}</h6>
																<div class="d-flex align-items-center">
																	{% if respuesta == 'si' %}
																		<span class="badge bg-success text-white me-2">
																			<i class="material-symbols-outlined me-1" style="font-size: 16px; vertical-align: middle;">check_circle</i>
																			Sí
																		</span>
																	{% elif respuesta == 'no' %}
																		<span class="badge bg-danger text-white me-2">
																			<i class="material-symbols-outlined me-1" style="font-size: 16px; vertical-align: middle;">cancel</i>
																			No
																		</span>
																	{% else %}
																		<span class="badge bg-secondary text-white me-2">{{ respuesta|default:"Sin respuesta" }}</span>
																	{% endif %}
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
											{% endfor %}
										</div>
									</div>
								</div>
							{% else %}
								<div class="alert alert-info">
									<p class="mb-0">
										<i class="material-symbols-outlined me-2" style="vertical-align: middle;">info</i>
										No hay respuestas de aplicación disponibles para este candidato.
									</p>
								</div>
							{% endif %}
						</div>
						<!-- Tab Match -->
						<div class="tab-pane fade" id="match-tab-pane" role="tabpanel" aria-labelledby="match-tab" tabindex="0">
							{% if json_match %}
								{% include "admin/vacancy/partials/match_candidate_vacancy.html" %}
							{% else %}
								<div class="alert alert-info">
									<p class="mb-0">No hay información de match disponible.</p>
								</div>
							{% endif %}
						</div>
						<!-- Tab Match Inicial -->
						<div class="tab-pane fade" id="match-inicial-tab-pane" role="tabpanel" aria-labelledby="match-inicial-tab" tabindex="0">
							{% if json_match_inicial %}
								<!-- Resumen de Ponderaciones -->
								{% if json_match_inicial.ponderaciones %}
								<div class="card bg-white border-0 rounded-3 mb-4">
									<div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
										<h5 class="text-primary my-2 fs-5 fw-semibold">Resumen de Ponderaciones</h5>
									</div>
									<div class="card-body p-4">
										<div class="table-responsive">
											<table class="table table-bordered">
												<thead class="bg-primary bg-opacity-10">
													<tr>
														<th class="text-center">Criterio</th>
														<th class="text-center">Porcentaje Obtenido</th>
														<th class="text-center">Ponderación Máxima</th>
													</tr>
												</thead>
												<tbody>
													{% if json_match_inicial.ponderaciones.educacion %}
													<tr>
														<td class="fw-semibold">Educación</td>
														<td class="text-center">
															<span class="badge bg-info text-white">{{ json_match_inicial.ponderaciones.educacion.porcentaje|floatformat:2 }}%</span>
														</td>
														<td class="text-center">{{ json_match_inicial.ponderaciones.educacion.ponderacion_maxima|floatformat:2 }}%</td>
													</tr>
													{% endif %}
													{% if json_match_inicial.ponderaciones.laboral %}
													<tr>
														<td class="fw-semibold">Laboral</td>
														<td class="text-center">
															<span class="badge bg-info text-white">{{ json_match_inicial.ponderaciones.laboral.porcentaje|floatformat:2 }}%</span>
														</td>
														<td class="text-center">{{ json_match_inicial.ponderaciones.laboral.ponderacion_maxima|floatformat:2 }}%</td>
													</tr>
													{% endif %}
													{% if json_match_inicial.ponderaciones.idioma %}
													<tr>
														<td class="fw-semibold">Idioma</td>
														<td class="text-center">
															<span class="badge bg-info text-white">{{ json_match_inicial.ponderaciones.idioma.porcentaje|floatformat:2 }}%</span>
														</td>
														<td class="text-center">{{ json_match_inicial.ponderaciones.idioma.ponderacion_maxima|floatformat:2 }}%</td>
													</tr>
													{% endif %}
													{% if json_match_inicial.ponderaciones.ubicacion %}
													<tr>
														<td class="fw-semibold">Ubicación</td>
														<td class="text-center">
															<span class="badge bg-info text-white">{{ json_match_inicial.ponderaciones.ubicacion.porcentaje|floatformat:2 }}%</span>
														</td>
														<td class="text-center">{{ json_match_inicial.ponderaciones.ubicacion.ponderacion_maxima|floatformat:2 }}%</td>
													</tr>
													{% endif %}
													<tr class="table-primary">
														<td class="fw-bold">TOTAL</td>
														<td class="text-center">
															<span class="badge bg-primary text-white fs-6">{{ json_match_inicial.ponderaciones.total|floatformat:2 }}%</span>
														</td>
														<td class="text-center fw-bold">{{ json_match_inicial.ponderaciones.total_maximo|floatformat:2 }}%</td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
								</div>
								{% endif %}

								<!-- Coincidencias de Educación -->
								{% if json_match_inicial.educacion and json_match_inicial.educacion.coincidencias_estudios %}
								<div class="card bg-white border-0 rounded-3 mb-4">
									<div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
										<h5 class="text-primary my-2 fs-5 fw-semibold">Coincidencias de Educación</h5>
									</div>
									<div class="card-body p-4">
										{% if json_match_inicial.educacion.match_academico %}
										<div class="mb-3 pb-3 border-bottom">
											<p class="mb-2"><strong>Porcentaje Match:</strong> <span class="badge bg-success text-white">{{ json_match_inicial.educacion.match_academico.porcentaje_match|floatformat:2 }}%</span></p>
										</div>
										{% endif %}
										{% for coincidencia in json_match_inicial.educacion.coincidencias_estudios %}
										<div class="card border rounded-3 mb-3">
											<div class="card-body p-4">
												<h6 class="fw-semibold mb-3 text-primary">{{ coincidencia.institucion|default:"Institución no especificada" }}</h6>
												<div class="row">
													<div class="col-md-6">
														<h6 class="fw-semibold mb-2">Candidato</h6>
														<ul class="list-unstyled">
															<li><strong>Tipo de Estudio:</strong> {{ coincidencia.candidato.tipo_estudio_display|default:"-" }}</li>
															<li><strong>Estado:</strong> {{ coincidencia.candidato.estado_estudios_display|default:"-" }}</li>
															<li><strong>Profesión:</strong> {{ coincidencia.candidato.profesion_estudio.nombre|default:"-" }}</li>
														</ul>
													</div>
													<div class="col-md-6">
														<h6 class="fw-semibold mb-2">Vacante</h6>
														<ul class="list-unstyled">
															<li><strong>Nivel Requerido:</strong> {{ coincidencia.vacante.nivel_estudio_display|default:"-" }}</li>
															<li><strong>Requiere Graduado:</strong> {{ coincidencia.vacante.requiere_graduado|yesno:"Sí,No,No especificado" }}</li>
															{% if coincidencia.vacante.profesion_estudio %}
															<li><strong>Profesión:</strong> 
																{% if coincidencia.vacante.profesion_estudio.tipo == 'Específica' %}
																	{{ coincidencia.vacante.profesion_estudio.nombre }}
																{% elif coincidencia.vacante.profesion_estudio.tipo == 'Grupo' %}
																	Grupo: {{ coincidencia.vacante.profesion_estudio.nombre }}
																{% elif coincidencia.vacante.profesion_estudio.tipo == 'Listado' %}
																	Listado personalizado
																{% endif %}
															</li>
															{% endif %}
														</ul>
													</div>
												</div>
												<div class="mt-3 pt-3 border-top">
													<h6 class="fw-semibold mb-2">Coincidencias</h6>
													<div class="row">
														<div class="col-md-4">
															<div class="d-flex align-items-center">
																{% if coincidencia.coincidencias.tipo_estudio.coincide %}
																<span class="badge bg-success text-white me-2"><i class="ri-check-line"></i></span>
																{% else %}
																<span class="badge bg-danger text-white me-2"><i class="ri-close-line"></i></span>
																{% endif %}
																<span><strong>Tipo de Estudio:</strong> {{ coincidencia.coincidencias.tipo_estudio.coincide|yesno:"Coincide,No coincide" }}</span>
															</div>
														</div>
														<div class="col-md-4">
															<div class="d-flex align-items-center">
																{% if coincidencia.coincidencias.graduado.coincide %}
																<span class="badge bg-success text-white me-2"><i class="ri-check-line"></i></span>
																{% else %}
																<span class="badge bg-danger text-white me-2"><i class="ri-close-line"></i></span>
																{% endif %}
																<span><strong>Graduado:</strong> {{ coincidencia.coincidencias.graduado.coincide|yesno:"Coincide,No coincide" }}</span>
															</div>
														</div>
														<div class="col-md-4">
															<div class="d-flex align-items-center">
																{% if coincidencia.coincidencias.profesion.coincide %}
																<span class="badge bg-success text-white me-2"><i class="ri-check-line"></i></span>
																{% else %}
																<span class="badge bg-danger text-white me-2"><i class="ri-close-line"></i></span>
																{% endif %}
																<span><strong>Profesión:</strong> {{ coincidencia.coincidencias.profesion.coincide|yesno:"Coincide,No coincide" }}</span>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
										{% endfor %}
									</div>
								</div>
								{% endif %}

								<!-- Detalle de Laboral -->
								{% if json_match_inicial.laboral %}
								<div class="card bg-white border-0 rounded-3 mb-4">
									<div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
										<h5 class="text-primary my-2 fs-5 fw-semibold">Experiencia Laboral</h5>
									</div>
									<div class="card-body p-4">
										{% if json_match_inicial.laboral.match_laboral %}
										<div class="mb-3 pb-3 border-bottom">
											<p class="mb-2"><strong>Porcentaje Match:</strong> <span class="badge bg-success text-white">{{ json_match_inicial.laboral.match_laboral.porcentaje_match|floatformat:2 }}%</span></p>
											<p class="mb-2"><strong>Años Totales de Experiencia:</strong> {{ json_match_inicial.laboral.match_laboral.anos_totales|floatformat:2 }} años</p>
										</div>
										{% endif %}
										{% if json_match_inicial.laboral.candidato.experiencias %}
										<h6 class="fw-semibold mb-3">Experiencias del Candidato</h6>
										{% for experiencia in json_match_inicial.laboral.candidato.experiencias %}
										<div class="card border rounded-3 mb-3">
											<div class="card-body p-3">
												<h6 class="fw-semibold mb-2">{{ experiencia.entidad|default:"Entidad no especificada" }}</h6>
												<p class="mb-1"><strong>Cargo:</strong> {{ experiencia.cargo|default:"-" }}</p>
												<p class="mb-1"><strong>Período:</strong> {{ experiencia.fecha_inicial|date:"Y"|default:"-" }} - {{ experiencia.fecha_final|date:"Y"|default:"Actual" }}</p>
											</div>
										</div>
										{% endfor %}
										{% endif %}
										{% if json_match_inicial.laboral.match_laboral.detalle %}
										<div class="mt-3 pt-3 border-top">
											<h6 class="fw-semibold mb-2">Coincidencias</h6>
											<div class="row">
												{% if json_match_inicial.laboral.match_laboral.detalle.anos_experiencia %}
												<div class="col-md-6">
													<div class="d-flex align-items-center mb-2">
														{% if json_match_inicial.laboral.match_laboral.detalle.anos_experiencia.coincide %}
														<span class="badge bg-success text-white me-2"><i class="ri-check-line"></i></span>
														{% else %}
														<span class="badge bg-danger text-white me-2"><i class="ri-close-line"></i></span>
														{% endif %}
														<span><strong>Años de Experiencia:</strong> 
															Candidato: {{ json_match_inicial.laboral.match_laboral.detalle.anos_experiencia.anos_candidato|floatformat:2 }}, 
															Requerido: {{ json_match_inicial.laboral.match_laboral.detalle.anos_experiencia.anos_requeridos|floatformat:2 }}
														</span>
													</div>
												</div>
												{% endif %}
												{% if json_match_inicial.laboral.match_laboral.detalle.cargo %}
												<div class="col-md-6">
													<div class="d-flex align-items-center mb-2">
														{% if json_match_inicial.laboral.match_laboral.detalle.cargo.coincide %}
														<span class="badge bg-success text-white me-2"><i class="ri-check-line"></i></span>
														{% else %}
														<span class="badge bg-danger text-white me-2"><i class="ri-close-line"></i></span>
														{% endif %}
														<span><strong>Cargo:</strong> {{ json_match_inicial.laboral.match_laboral.detalle.cargo.coincide|yesno:"Coincide,No coincide" }}</span>
													</div>
												</div>
												{% endif %}
											</div>
										</div>
										{% endif %}
									</div>
								</div>
								{% endif %}

								<!-- Detalle de Idioma -->
								{% if json_match_inicial.idioma %}
								<div class="card bg-white border-0 rounded-3 mb-4">
									<div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
										<h5 class="text-primary my-2 fs-5 fw-semibold">Idiomas</h5>
									</div>
									<div class="card-body p-4">
										{% if json_match_inicial.idioma.match_idioma %}
										<div class="mb-3 pb-3 border-bottom">
											<p class="mb-2"><strong>Porcentaje Match:</strong> <span class="badge bg-success text-white">{{ json_match_inicial.idioma.match_idioma.porcentaje_match|floatformat:2 }}%</span></p>
										</div>
										{% endif %}
										<div class="row">
											<div class="col-md-6">
												<h6 class="fw-semibold mb-2">Idiomas del Candidato</h6>
												{% if json_match_inicial.idioma.candidato.idiomas %}
												<ul class="list-unstyled">
													{% for idioma in json_match_inicial.idioma.candidato.idiomas %}
													<li class="mb-2">
														<span class="badge bg-info text-white me-2">{{ idioma.nombre|default:idioma.id }}</span>
														<span>{{ idioma.nivel|default:"-" }}</span>
													</li>
													{% endfor %}
												</ul>
												{% else %}
												<p class="text-muted">No hay idiomas registrados</p>
												{% endif %}
											</div>
											<div class="col-md-6">
												<h6 class="fw-semibold mb-2">Idiomas Requeridos por la Vacante</h6>
												{% if json_match_inicial.idioma.vacante.idiomas %}
												<ul class="list-unstyled">
													{% for idioma in json_match_inicial.idioma.vacante.idiomas %}
													<li class="mb-2">
														<span class="badge bg-warning text-dark me-2">{{ idioma.nombre|default:idioma.idioma }}</span>
														<span>{{ idioma.nivel|default:"-" }}</span>
													</li>
													{% endfor %}
												</ul>
												{% else %}
												<p class="text-muted">No se requieren idiomas específicos</p>
												{% endif %}
											</div>
										</div>
										{% if json_match_inicial.idioma.match_idioma.mejor_match %}
										<div class="mt-3 pt-3 border-top">
											<h6 class="fw-semibold mb-2">Mejor Coincidencia</h6>
											<div class="d-flex align-items-center">
												{% if json_match_inicial.idioma.match_idioma.detalle.idioma.coincide %}
												<span class="badge bg-success text-white me-2"><i class="ri-check-line"></i></span>
												{% else %}
												<span class="badge bg-danger text-white me-2"><i class="ri-close-line"></i></span>
												{% endif %}
												<span><strong>Idioma:</strong> {{ json_match_inicial.idioma.match_idioma.mejor_match.idioma_candidato|default:"-" }} vs {{ json_match_inicial.idioma.match_idioma.mejor_match.idioma_vacante|default:"-" }}</span>
											</div>
											<div class="d-flex align-items-center mt-2">
												{% if json_match_inicial.idioma.match_idioma.detalle.nivel.coincide %}
												<span class="badge bg-success text-white me-2"><i class="ri-check-line"></i></span>
												{% else %}
												<span class="badge bg-danger text-white me-2"><i class="ri-close-line"></i></span>
												{% endif %}
												<span><strong>Nivel:</strong> {{ json_match_inicial.idioma.match_idioma.mejor_match.nivel_candidato|default:"-" }} vs {{ json_match_inicial.idioma.match_idioma.mejor_match.nivel_vacante|default:"-" }}</span>
											</div>
										</div>
										{% endif %}
									</div>
								</div>
								{% endif %}

								<!-- Detalle de Ubicación -->
								{% if json_match_inicial.ubicacion %}
								<div class="card bg-white border-0 rounded-3 mb-4">
									<div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
										<h5 class="text-primary my-2 fs-5 fw-semibold">Ubicación</h5>
									</div>
									<div class="card-body p-4">
										{% if json_match_inicial.ubicacion.match_ubicacion %}
										<div class="mb-3 pb-3 border-bottom">
											<p class="mb-2"><strong>Porcentaje Match:</strong> <span class="badge bg-success text-white">{{ json_match_inicial.ubicacion.match_ubicacion.porcentaje_match|floatformat:2 }}%</span></p>
										</div>
										{% endif %}
										<div class="row">
											<div class="col-md-6">
												<h6 class="fw-semibold mb-2">Ciudad del Candidato</h6>
												<p>{{ json_match_inicial.ubicacion.candidato.ciudad.nombre|default:"No especificada" }}</p>
											</div>
											<div class="col-md-6">
												<h6 class="fw-semibold mb-2">Ciudad de la Vacante</h6>
												<p>{{ json_match_inicial.ubicacion.vacante.ciudad.nombre|default:"No especificada" }}</p>
											</div>
										</div>
										{% if json_match_inicial.ubicacion.match_ubicacion.detalle %}
										<div class="mt-3 pt-3 border-top">
											<div class="d-flex align-items-center">
												{% if json_match_inicial.ubicacion.match_ubicacion.detalle.coincide %}
												<span class="badge bg-success text-white me-2"><i class="ri-check-line"></i></span>
												<span class="fw-semibold">Las ciudades coinciden</span>
												{% else %}
												<span class="badge bg-danger text-white me-2"><i class="ri-close-line"></i></span>
												<span class="fw-semibold">Las ciudades no coinciden</span>
												{% endif %}
											</div>
											{% if json_match_inicial.ubicacion.match_ubicacion.detalle.mensaje %}
											<p class="text-muted mt-2 mb-0">{{ json_match_inicial.ubicacion.match_ubicacion.detalle.mensaje }}</p>
											{% endif %}
										</div>
										{% endif %}
									</div>
								</div>
								{% endif %}
							{% else %}
								<div class="alert alert-info">
									<p class="mb-0">No hay información de match inicial disponible.</p>
								</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Columna lateral con formulario de cambio de estado -->
		<div class="col-md-3">
			<div class="card bg-white border-0 rounded-3 mb-4">
				<div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
					<p class="text-primary my-2 fs-5 fw-semibold">Cambiar Estado</p>
				</div>
				<div class="card-body p-4">
					{% crispy form %}
				</div>
			</div>

			<!-- Historial de cambios de estado -->
			{% if historial_estados %}
			<div class="card bg-white border-0 rounded-3 mb-4">
				<div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
					<p class="text-primary my-2 fs-5 fw-semibold">Historial de Estados</p>
				</div>
				<div class="card-body p-4">
					<div class="timeline">
						{% for registro in historial_estados reversed %}
						<div class="position-relative ps-4 pb-4 mb-3">
							<div class="position-absolute start-0 top-0 h-100" style="width: 2px; background-color: #dee2e6;"></div>
							<div class="position-absolute start-0 top-0" style="width: 12px; height: 12px; background-color: #B10022; border-radius: 50%; transform: translateX(-5px); border: 2px solid #ffffff;"></div>
							<div class="small text-muted mb-1">
								{% if registro.fecha_hora_actualizacion %}
									{% if "T" in registro.fecha_hora_actualizacion %}
										{{ registro.fecha_hora_actualizacion|slice:":10"|date:"d/m/Y" }} {{ registro.fecha_hora_actualizacion|slice:"11:16" }}
									{% else %}
										{{ registro.fecha_hora_actualizacion }}
									{% endif %}
								{% else %}
									-
								{% endif %}
							</div>
							<div class="mb-1">
								<span class="badge bg-secondary">{{ registro.estado_anterior.nombre }}</span>
								<span class="mx-1">→</span>
								<span class="badge bg-primary">{{ registro.estado_nuevo.nombre }}</span>
							</div>
							{% if registro.comentario %}
							<p class="small text-muted mb-0">{{ registro.comentario }}</p>
							{% endif %}
						</div>
						{% empty %}
						<p class="text-muted small">No hay historial de cambios de estado.</p>
						{% endfor %}
					</div>
				</div>
			</div>
			{% endif %}
		</div>
	</div>
</div>

<!-- Modal para ver la Hoja de Vida -->
{% if candidato.hoja_de_vida %}
<div class="modal fade" id="modalHojaVida" tabindex="-1" aria-labelledby="modalHojaVidaLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header bg-primary bg-opacity-10 text-primary">
				<h5 class="modal-title d-flex align-items-center" id="modalHojaVidaLabel">
					<i class="material-symbols-outlined me-2" style="vertical-align: middle;">description</i>
					<span>Hoja de Vida - {{ candidato.nombre_completo }}</span>
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body p-0">
				<div class="d-flex justify-content-center align-items-center" style="min-height: 500px;">
					<iframe src="{{ candidato.hoja_de_vida.url }}" style="width: 100%; height: 80vh; border: none;" frameborder="0"></iframe>
				</div>
			</div>
			<div class="modal-footer">
				<a href="{{ candidato.hoja_de_vida.url }}" target="_blank" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100">
					<i class="material-symbols-outlined me-2" style="vertical-align: middle;">open_in_new</i>
					Abrir en nueva pestaña
				</a>
				<button type="button" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100" data-bs-dismiss="modal">Cerrar</button>
			</div>
		</div>
	</div>
</div>
{% endif %}
{% endblock %}

{% block js %}
<script>
$(document).ready(function() {
    // Inicializar Select2 para el campo de estado
    initializeSelect2('#id_estado_reclutamiento');
});
</script>
{% endblock js %}

{% extends 'admin/layout/dashboard_base.html' %} 

{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load custom_tags %}

{% block title %}
Gestión de Vacante - Reclutador
{% endblock %}

{% block content %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

<div class="main-content-container overflow-hidden">
	<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
		<h3 class="mb-0" style="color: #B10022;">
			{% if data %}
				CLIENTE: {{data.cliente.razon_social}}
			{% else %}
				GESTIÓN DE VACANTE
			{% endif %}
		</h3>
		<nav style="--bs-breadcrumb-divider: '>'" aria-label="breadcrumb">
			<ol class="breadcrumb align-items-center mb-0 lh-1">
				<li class="breadcrumb-item">
					<a href="{% url 'accesses:inicio' %}" class="d-flex align-items-center text-decoration-none">
						<i class="ri-home-4-line fs-18 text-primary me-1"></i>
						<span class="text-secondary fw-medium hover" >Inicio</span>
					</a>
				</li>
				<li class="breadcrumb-item active" aria-current="page">
					<a href="{% url 'reclutados:vacantes_asignadas_reclutador' %}" class="d-flex align-items-center text-decoration-none">
						<span class="text-secondary fw-medium hover" >Vacantes Asignadas</span>
					</a>
				</li>
				<li class="breadcrumb-item active" aria-current="page">
					<span class="fw-medium">Gestión de Vacante</span>
				</li>
			</ol>
		</nav>
	</div>

	<div class="row">
        <div class="col-md-12">
			<div class="card bg-white border-0 rounded-3 mb-4">
                <div class="card-header bg-primary bg-opacity-10 align-middle border-0"> 
                    <p class="text-primary my-2 fs-4 fw-semibold">Gestión Vacante: {{vacante.titulo}}</p>
                </div>
                <div class="card-body p-4">
                    <nav>
                        <div class="nav nav-tabs mb-4" id="nav-tab" role="tablist">
                            <button class="nav-link active" id="nav-reclutado-tab" data-bs-toggle="tab" data-bs-target="#nav-reclutado" type="button" role="tab" aria-controls="nav-reclutado" aria-selected="true">Reclutados</button>
                            <button class="nav-link" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="false">Información</button>
                            <button class="nav-link" id="nav-contact-tab" data-bs-toggle="tab" data-bs-target="#nav-contact" type="button" role="tab" aria-controls="nav-contact" aria-selected="false">Preguntas Vacante</button>
                        </div>
                    </nav>
                    <div class="tab-content" id="nav-tabContent">
                        <div class="tab-pane fade show active" id="nav-reclutado" role="tabpanel" aria-labelledby="nav-reclutado-tab" tabindex="0">
                            <!-- Sub-tabs para estados dentro del tab Reclutados -->
                            <nav>
                                <div class="nav nav-tabs mb-4" id="nav-estados-tab" role="tablist">
                                    <button class="nav-link active" id="nav-recibido-tab" data-bs-toggle="tab" data-bs-target="#nav-recibido" type="button" role="tab" aria-controls="nav-recibido" aria-selected="true">
                                        Recibido <span class="badge bg-warning text-dark ms-2">{{ reclutados_recibido|length }}</span>
                                    </button>
                                    <button class="nav-link" id="nav-seleccionado-tab" data-bs-toggle="tab" data-bs-target="#nav-seleccionado" type="button" role="tab" aria-controls="nav-seleccionado" aria-selected="false">
                                        Seleccionado <span class="badge bg-success text-white ms-2">{{ reclutados_seleccionado|length }}</span>
                                    </button>
                                    <button class="nav-link" id="nav-finalizalista-tab" data-bs-toggle="tab" data-bs-target="#nav-finalizalista" type="button" role="tab" aria-controls="nav-finalizalista" aria-selected="false">
                                        Finalista <span class="badge bg-primary text-white ms-2">{{ reclutados_finalizalista|length }}</span>
                                    </button>
                                    <button class="nav-link" id="nav-descartado-tab" data-bs-toggle="tab" data-bs-target="#nav-descartado" type="button" role="tab" aria-controls="nav-descartado" aria-selected="false">
                                        Descartado <span class="badge bg-danger text-white ms-2">{{ reclutados_descartado|length }}</span>
                                    </button>
                                </div>
                            </nav>
                            <div class="tab-content" id="nav-estados-tabContent">
                                <!-- Tab: Recibido -->
                                <div class="tab-pane fade show active" id="nav-recibido" role="tabpanel" aria-labelledby="nav-recibido-tab" tabindex="0">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="card bg-white border-0 rounded-3 mb-4">
                                                <div class="card-body p-3">
                                                    {% crispy form_busqueda %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-9">
                                            <div class="card bg-white border-0 rounded-3 mb-4">
                                                <div class="default-table-area all-projects">
                                                    <div class="table-responsive">
                                                        <table class="table align-middle text-center" id="tableRecibido">
                                                            <thead>
                                                                <tr>
                                                                    <th scope="col" class="text-center">Imagen</th>
                                                                    <th scope="col" class="text-center">Candidato</th>
                                                                    <th scope="col" class="text-center">Fecha Registro</th>
                                                                    <th scope="col" class="text-center">Edad</th>
                                                                    <th scope="col" class="text-center">Nivel de Estudio</th>
                                                                    <th scope="col" class="text-center">Puntaje Match</th>
                                                                    <th scope="col" class="text-center">Acciones</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for e in reclutados_recibido %}
                                                                <tr>
                                                                    <td class="text-center">
                                                                        {% if e.candidato_101.imagen_perfil %}
                                                                            <img src="{{ e.candidato_101.imagen_perfil.url }}" alt="{{ e.candidato_nombre }}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                                        {% else %}
                                                                            <img src="{% static 'admin/images/blank.png' %}" alt="Sin imagen" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                                        {% endif %}
                                                                    </td>
                                                                    <td class="text-start">
                                                                        <a href="{% url 'reclutados:reclutados_detalle_reclutador' e.id %}" class="fw-semibold text-decoration-none text-dark d-block">{{ e.candidato_nombre }}</a>
                                                                        <small class="text-muted">{{ e.candidato_email|default:"-" }}</small>
                                                                    </td>
                                                                    <td class="text-secondary">{{ e.fecha_aplicacion|date:"d/m/Y"|default:"-" }}</td>
                                                                    <td class="text-secondary">
                                                                        {% if e.candidato_101.fecha_nacimiento %}
                                                                            <span class="edad-candidato" data-fecha-nacimiento="{{ e.candidato_101.fecha_nacimiento|date:'Y-m-d' }}">-</span>
                                                                        {% else %}
                                                                            -
                                                                        {% endif %}
                                                                    </td>
                                                                    <td class="text-secondary nivel-estudio" data-candidato-id="{{ e.candidato_id }}">
                                                                        {% with educaciones=e.candidato_101.can103educacion_set.all %}
                                                                            {% if educaciones %}
                                                                                {% for educacion in educaciones %}
                                                                                    {% if educacion.tipo_estudio %}
                                                                                        <span class="nivel-estudio-valor" data-nivel="{{ educacion.tipo_estudio }}" data-texto="{{ educacion.mostrar_tipo_estudio }}"></span>
                                                                                    {% endif %}
                                                                                {% endfor %}
                                                                            {% else %}
                                                                                -
                                                                            {% endif %}
                                                                        {% endwith %}
                                                                    </td>
                                                                    <td class="text-center">
                                                                        {% with porcentaje=e.json_match|get_match_porcentaje %}
                                                                            {% if porcentaje %}
                                                                                {% if porcentaje >= 80 %}
                                                                                    <span class="badge bg-success text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                                {% elif porcentaje >= 60 %}
                                                                                    <span class="badge bg-warning text-dark p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                                {% elif porcentaje >= 40 %}
                                                                                    <span class="badge bg-info text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                                {% else %}
                                                                                    <span class="badge bg-secondary text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                                {% endif %}
                                                                            {% else %}
                                                                                <span class="text-muted">-</span>
                                                                            {% endif %}
                                                                        {% endwith %}
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <a href="{% url 'reclutados:reclutados_detalle_reclutador' e.id %}" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100">
                                                                            <i class="material-symbols-outlined fs-14">visibility</i> Ver
                                                                        </a>
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                                
                                </div>
                                
                                <!-- Tab: Seleccionado -->
                                <div class="tab-pane fade" id="nav-seleccionado" role="tabpanel" aria-labelledby="nav-seleccionado-tab" tabindex="0">
                                    <div class="default-table-area all-projects">
                                        <div class="table-responsive">
                                            <table class="table align-middle text-center" id="tableSeleccionado">
                                                <thead>
                                                    <tr>
                                                        <th scope="col" class="text-center">Imagen</th>
                                                        <th scope="col" class="text-center">Candidato</th>
                                                        <th scope="col" class="text-center">Fecha Registro</th>
                                                        <th scope="col" class="text-center">Edad</th>
                                                        <th scope="col" class="text-center">Nivel de Estudio</th>
                                                        <th scope="col" class="text-center">Puntaje Match</th>
                                                        <th scope="col" class="text-center">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for e in reclutados_seleccionado %}
                                                    <tr>
                                                        <td class="text-center">
                                                            {% if e.candidato_101.imagen_perfil %}
                                                                <img src="{{ e.candidato_101.imagen_perfil.url }}" alt="{{ e.candidato_nombre }}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                            {% else %}
                                                                <img src="{% static 'admin/images/blank.png' %}" alt="Sin imagen" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-start">
                                                            <a href="{% url 'reclutados:reclutados_detalle_reclutador' e.id %}" class="fw-semibold text-decoration-none text-dark d-block">{{ e.candidato_nombre }}</a>
                                                            <small class="text-muted">{{ e.candidato_email|default:"-" }}</small>
                                                        </td>
                                                        <td class="text-secondary">{{ e.fecha_aplicacion|date:"d/m/Y"|default:"-" }}</td>
                                                        <td class="text-secondary">
                                                            {% if e.candidato_101.fecha_nacimiento %}
                                                                <span class="edad-candidato" data-fecha-nacimiento="{{ e.candidato_101.fecha_nacimiento|date:'Y-m-d' }}">-</span>
                                                            {% else %}
                                                                -
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-secondary nivel-estudio" data-candidato-id="{{ e.candidato_id }}">
                                                            {% with educaciones=e.candidato_101.can103educacion_set.all %}
                                                                {% if educaciones %}
                                                                    {% for educacion in educaciones %}
                                                                        {% if educacion.tipo_estudio %}
                                                                            <span class="nivel-estudio-valor" data-nivel="{{ educacion.tipo_estudio }}" data-texto="{{ educacion.mostrar_tipo_estudio }}"></span>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                {% else %}
                                                                    -
                                                                {% endif %}
                                                            {% endwith %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% with porcentaje=e.json_match|get_match_porcentaje %}
                                                                {% if porcentaje %}
                                                                    {% if porcentaje >= 80 %}
                                                                        <span class="badge bg-success text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% elif porcentaje >= 60 %}
                                                                        <span class="badge bg-warning text-dark p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% elif porcentaje >= 40 %}
                                                                        <span class="badge bg-info text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </td>
                                                        <td class="text-center">
                                                            <a href="{% url 'reclutados:reclutados_detalle_reclutador' e.id %}" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100">
                                                                <i class="material-symbols-outlined fs-14">visibility</i> Ver
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tab: finalista -->
                                <div class="tab-pane fade" id="nav-finalizalista" role="tabpanel" aria-labelledby="nav-finalizalista-tab" tabindex="0">
                                    <div class="mb-3 d-flex justify-content-start align-items-center">
                                        <button type="button" id="btnAsignarEntrevistas" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4" disabled>
                                            <i class="material-symbols-outlined me-2">group_add</i>
                                            Asignar Entrevistas (<span id="contadorSeleccionados">0</span>)
                                        </button>
                                    </div>
                                    <div class="default-table-area all-projects">
                                        <div class="table-responsive">
                                            <table class="table align-middle text-center" id="tablefinalista">
                                                <thead>
                                                    <tr>
                                                        <th scope="col" class="text-center" style="width: 40px;">
                                                            <input type="checkbox" id="selectAllFinalistas" class="form-check-input">
                                                        </th>
                                                        <th scope="col" class="text-center">Imagen</th>
                                                        <th scope="col" class="text-center">Candidato</th>
                                                        <th scope="col" class="text-center">Fecha Registro</th>
                                                        <th scope="col" class="text-center">Edad</th>
                                                        <th scope="col" class="text-center">Nivel de Estudio</th>
                                                        <th scope="col" class="text-center">Puntaje Match</th>
                                                        <th scope="col" class="text-center">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for e in reclutados_finalizalista %}
                                                    <tr>
                                                        <td class="text-center">
                                                            <input type="checkbox" class="form-check-input checkbox-finalista" data-id="{{ e.id }}" data-nombre="{{ e.candidato_nombre }}" data-email="{{ e.candidato_email }}" data-imagen="{% if e.candidato_101.imagen_perfil %}{{ e.candidato_101.imagen_perfil.url }}{% else %}{% static 'admin/images/blank.png' %}{% endif %}">
                                                        </td>
                                                        <td class="text-center">
                                                            {% if e.candidato_101.imagen_perfil %}
                                                                <img src="{{ e.candidato_101.imagen_perfil.url }}" alt="{{ e.candidato_nombre }}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                            {% else %}
                                                                <img src="{% static 'admin/images/blank.png' %}" alt="Sin imagen" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-start">
                                                            <a href="{% url 'reclutados:reclutados_detalle_reclutador' e.id %}" class="fw-semibold text-decoration-none text-dark d-block">{{ e.candidato_nombre }}</a>
                                                            <small class="text-muted">{{ e.candidato_email|default:"-" }}</small>
                                                        </td>
                                                        <td class="text-secondary">{{ e.fecha_aplicacion|date:"d/m/Y"|default:"-" }}</td>
                                                        <td class="text-secondary">
                                                            {% if e.candidato_101.fecha_nacimiento %}
                                                                <span class="edad-candidato" data-fecha-nacimiento="{{ e.candidato_101.fecha_nacimiento|date:'Y-m-d' }}">-</span>
                                                            {% else %}
                                                                -
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-secondary nivel-estudio" data-candidato-id="{{ e.candidato_id }}">
                                                            {% with educaciones=e.candidato_101.can103educacion_set.all %}
                                                                {% if educaciones %}
                                                                    {% for educacion in educaciones %}
                                                                        {% if educacion.tipo_estudio %}
                                                                            <span class="nivel-estudio-valor" data-nivel="{{ educacion.tipo_estudio }}" data-texto="{{ educacion.mostrar_tipo_estudio }}"></span>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                {% else %}
                                                                    -
                                                                {% endif %}
                                                            {% endwith %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% with porcentaje=e.json_match|get_match_porcentaje %}
                                                                {% if porcentaje %}
                                                                    {% if porcentaje >= 80 %}
                                                                        <span class="badge bg-success text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% elif porcentaje >= 60 %}
                                                                        <span class="badge bg-warning text-dark p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% elif porcentaje >= 40 %}
                                                                        <span class="badge bg-info text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </td>
                                                        <td class="text-center">
                                                            <a href="{% url 'reclutados:reclutados_detalle_reclutador' e.id %}" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100">
                                                                <i class="material-symbols-outlined fs-14">visibility</i> Ver
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tab: Descartado -->
                                <div class="tab-pane fade" id="nav-descartado" role="tabpanel" aria-labelledby="nav-descartado-tab" tabindex="0">
                                    <div class="default-table-area all-projects">
                                        <div class="table-responsive">
                                            <table class="table align-middle text-center" id="tableDescartado">
                                                <thead>
                                                    <tr>
                                                        <th scope="col" class="text-center">Imagen</th>
                                                        <th scope="col" class="text-center">Candidato</th>
                                                        <th scope="col" class="text-center">Fecha Registro</th>
                                                        <th scope="col" class="text-center">Edad</th>
                                                        <th scope="col" class="text-center">Nivel de Estudio</th>
                                                        <th scope="col" class="text-center">Puntaje Match</th>
                                                        <th scope="col" class="text-center">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for e in reclutados_descartado %}
                                                    <tr>
                                                        <td class="text-center">
                                                            {% if e.candidato_101.imagen_perfil %}
                                                                <img src="{{ e.candidato_101.imagen_perfil.url }}" alt="{{ e.candidato_nombre }}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                            {% else %}
                                                                <img src="{% static 'admin/images/blank.png' %}" alt="Sin imagen" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-start">
                                                            <a href="{% url 'reclutados:reclutados_detalle_reclutador' e.id %}" class="fw-semibold text-decoration-none text-dark d-block">{{ e.candidato_nombre }}</a>
                                                            <small class="text-muted">{{ e.candidato_email|default:"-" }}</small>
                                                        </td>
                                                        <td class="text-secondary">{{ e.fecha_aplicacion|date:"d/m/Y"|default:"-" }}</td>
                                                        <td class="text-secondary">
                                                            {% if e.candidato_101.fecha_nacimiento %}
                                                                <span class="edad-candidato" data-fecha-nacimiento="{{ e.candidato_101.fecha_nacimiento|date:'Y-m-d' }}">-</span>
                                                            {% else %}
                                                                -
                                                            {% endif %}
                                                        </td>
                                                        <td class="text-secondary nivel-estudio" data-candidato-id="{{ e.candidato_id }}">
                                                            {% with educaciones=e.candidato_101.can103educacion_set.all %}
                                                                {% if educaciones %}
                                                                    {% for educacion in educaciones %}
                                                                        {% if educacion.tipo_estudio %}
                                                                            <span class="nivel-estudio-valor" data-nivel="{{ educacion.tipo_estudio }}" data-texto="{{ educacion.mostrar_tipo_estudio }}"></span>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                {% else %}
                                                                    -
                                                                {% endif %}
                                                            {% endwith %}
                                                        </td>
                                                        <td class="text-center">
                                                            {% with porcentaje=e.json_match|get_match_porcentaje %}
                                                                {% if porcentaje %}
                                                                    {% if porcentaje >= 80 %}
                                                                        <span class="badge bg-success text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% elif porcentaje >= 60 %}
                                                                        <span class="badge bg-warning text-dark p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% elif porcentaje >= 40 %}
                                                                        <span class="badge bg-info text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary text-white p-2">{{ porcentaje|floatformat:1 }}%</span>
                                                                    {% endif %}
                                                                {% else %}
                                                                    <span class="text-muted">-</span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </td>
                                                        <td class="text-center">
                                                            <a href="{% url 'reclutados:reclutados_detalle_reclutador' e.id %}" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4 w-100">
                                                                <i class="material-symbols-outlined fs-14">visibility</i> Ver
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" tabindex="0">
                            {% include 'admin/vacancy/partials/presentation_vacancy.html' %}
                        </div>
                        <div class="tab-pane fade" id="nav-contact" role="tabpanel" aria-labelledby="nav-contact-tab" tabindex="0">
                            <div class="mb-4">
                                <div class="px-2 pt-2 pb-0">
                                    <span class="fw-semibold text-secondary" style="font-size: 1.05rem;">
                                        <i class="bi bi-question-circle me-1 text-primary"></i>
                                        Preguntas generadas para la vacante
                                    </span>
                                </div>
                                <div class="pt-2 px-2">
                                    {% if preguntas %}
                                        <ul class="ps-0 mb-0" style="list-style: none;">
                                            {% for pregunta in preguntas %}
                                                <li class="d-flex align-items-start mb-2">
                                                    <span class="me-2 mt-1">
                                                        <i class="material-symbols-outlined text-primary">help</i>
                                                    </span>
                                                    <span>{{ pregunta.pregunta }}</span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <div class="alert alert-info mb-0">
                                            No hay preguntas generadas para esta vacante.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
		</div>
	</div>

</div>

<!-- Modal para Asignar Entrevistas Múltiples -->
<div class="modal fade" id="modalAsignarEntrevistas" tabindex="-1" aria-labelledby="modalAsignarEntrevistasLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary bg-opacity-10 text-primary">
                <h5 class="modal-title d-flex align-items-center" id="modalAsignarEntrevistasLabel">
                    <i class="material-symbols-outlined me-2">event</i>
                    Asignar Entrevistas a Candidatos Seleccionados
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formAsignarEntrevistas" method="post" action="{% url 'reclutados:crear_entrevistas_multiples' pk vacante.id %}">
                {% csrf_token %}
                <input type="hidden" name="aplicaciones_ids" id="aplicacionesIdsInput">
                <div class="modal-body">
                    <!-- Listado de candidatos seleccionados -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">Candidatos Seleccionados (<span id="contadorModal">0</span>)</h6>
                        <div id="listadoCandidatos" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-muted text-center">No hay candidatos seleccionados</div>
                        </div>
                    </div>
                    
                    <!-- Formulario de entrevista -->
                    {% crispy form_entrevista_multiples %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-secondary bg-opacity-10 fw-medium text-secondary py-2 px-4" data-bs-dismiss="modal">
                        <i class="material-symbols-outlined me-2">close</i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn bg-primary bg-opacity-10 fw-medium text-primary py-2 px-4">
                        <i class="material-symbols-outlined me-2">save</i>
                        Asignar Entrevistas
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block js %} 
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Verificar que DataTables esté disponible
    if (typeof $.fn.DataTable === 'undefined') {
        console.error('DataTables no está cargado');
        return;
    }

    // Configuración común para todos los DataTables con todas las funcionalidades
    var dataTableConfig = {
        "dom": '<"row mb-3"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        "language": {
            "lengthMenu": "Mostrar _MENU_ registros por página",
            "zeroRecords": "No dirse encontraron registros",
            "info": "Mostrando página _PAGE_ de _PAGES_",
            "infoEmpty": "No hay registros disponibles",
            "infoFiltered": "(filtrado de _MAX_ registros totales)",
            "search": "Buscar:",
            "searchPlaceholder": "Buscar",
            "paginate": {
                "first": "Primero",
                "last": "Último",
                "next": "Siguiente",
                "previous": "Anterior"
            },
            "emptyTable": "No hay candidatos en este estado",
            "loadingRecords": "Cargando...",
            "processing": "Procesando...",
            "infoThousands": ","
        },
        "columnDefs": [
            {
                "targets": [0, 6], // Columna de Imagen y Acciones
                "orderable": false,
                "searchable": false
            }
        ],
        "order": [[2, "desc"]], // Ordenar por Fecha Registro descendente
        "responsive": true,
        "autoWidth": false,
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
        "searching": true,
        "ordering": true,
        "info": true,
        "paging": true,
        "processing": false,
        "deferRender": false,
        "destroy": false,
        "retrieve": true
    };

    // Variables para almacenar las instancias de DataTable
    var tableRecibido = null;
    var tableSeleccionado = null;
    var tablefinalista = null;
    var tableDescartado = null;

    // Función para inicializar DataTable solo si no existe
    function initDataTable(tableId) {
        var tableElement = $('#' + tableId);
        
        if (tableElement.length === 0) {
            console.warn('Tabla ' + tableId + ' no encontrada');
            return null;
        }

        if (!$.fn.DataTable.isDataTable('#' + tableId)) {
            try {
                // Limpiar cualquier fila con colspan que pueda causar problemas
                var tbody = tableElement.find('tbody');
                tbody.find('tr').each(function() {
                    var $row = $(this);
                    var $tdWithColspan = $row.find('td[colspan]');
                    if ($tdWithColspan.length > 0) {
                        $row.remove();
                    }
                });
                
                var table = tableElement.DataTable(dataTableConfig);
                console.log('DataTable inicializado para: ' + tableId);
                return table;
            } catch (error) {
                console.error('Error al inicializar DataTable para ' + tableId + ':', error);
                return null;
            }
        } else {
            // Si ya existe, obtener la instancia
            return tableElement.DataTable();
        }
    }

    // Inicializar DataTable para Recibido (tab activo por defecto)
    setTimeout(function() {
        if ($('#tableRecibido').length && $('#nav-recibido').hasClass('show active')) {
            tableRecibido = initDataTable('tableRecibido');
        }
    }, 500);

    // Inicializar DataTables cuando se muestren los tabs
    $('#nav-recibido-tab').on('shown.bs.tab', function (e) {
        setTimeout(function() {
            if (!tableRecibido) {
                tableRecibido = initDataTable('tableRecibido');
            } else {
                // Redibujar la tabla si ya existe
                tableRecibido.columns.adjust().draw();
            }
        }, 200);
    });

    $('#nav-seleccionado-tab').on('shown.bs.tab', function (e) {
        setTimeout(function() {
            if (!tableSeleccionado) {
                tableSeleccionado = initDataTable('tableSeleccionado');
            } else {
                tableSeleccionado.columns.adjust().draw();
            }
        }, 200);
    });

    $('#nav-finalizalista-tab').on('shown.bs.tab', function (e) {
        setTimeout(function() {
            if (!tablefinalista) {
                tablefinalista = initDataTable('tablefinalista');
            } else {
                tablefinalista.columns.adjust().draw();
            }
        }, 200);
    });

    $('#nav-descartado-tab').on('shown.bs.tab', function (e) {
        setTimeout(function() {
            if (!tableDescartado) {
                tableDescartado = initDataTable('tableDescartado');
            } else {
                tableDescartado.columns.adjust().draw();
            }
        }, 200);
    });

    // Función para calcular la edad
    function calcularEdad(fechaNacimiento) {
        if (!fechaNacimiento) return '-';
        
        var hoy = new Date();
        var fechaNac = new Date(fechaNacimiento);
        var edad = hoy.getFullYear() - fechaNac.getFullYear();
        var mes = hoy.getMonth() - fechaNac.getMonth();
        
        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
            edad--;
        }
        
        return edad + ' años';
    }

    // Calcular edades de todos los candidatos
    $('.edad-candidato').each(function() {
        var fechaNacimiento = $(this).data('fecha-nacimiento');
        if (fechaNacimiento) {
            $(this).text(calcularEdad(fechaNacimiento));
        }
    });

    // Obtener el nivel de estudio más alto para cada candidato
    $('.nivel-estudio').each(function() {
        var $td = $(this);
        var $niveles = $td.find('.nivel-estudio-valor');
        
        if ($niveles.length > 0) {
            var nivelMax = 0;
            var textoMax = '';
            
            $niveles.each(function() {
                var nivel = parseInt($(this).data('nivel')) || 0;
                if (nivel > nivelMax) {
                    nivelMax = nivel;
                    textoMax = $(this).data('texto');
        }
            });
            
            if (textoMax) {
                $td.text(textoMax);
            } else {
                $td.text('-');
            }
        }
    });

    // Inicializar Select2 para el campo de nivel de estudio en el formulario de búsqueda
    if ($('#id_nivel_estudio').length) {
        initializeSelect2('#id_nivel_estudio');
    }

    // ============================================
    // MANEJO DE SELECCIÓN MÚLTIPLE PARA ENTREVISTAS
    // ============================================
    
    // Función para actualizar el contador y el botón
    function actualizarSeleccion() {
        var checkboxes = $('.checkbox-finalista:checked');
        var cantidad = checkboxes.length;
        
        $('#contadorSeleccionados').text(cantidad);
        $('#contadorModal').text(cantidad);
        
        var $btn = $('#btnAsignarEntrevistas');
        if (cantidad > 0) {
            $btn.prop('disabled', false);
            $btn.css('opacity', '1');
            $btn.css('cursor', 'pointer');
        } else {
            $btn.prop('disabled', true);
            $btn.css('opacity', '0.6');
            $btn.css('cursor', 'not-allowed');
        }
        
        // Actualizar listado en el modal
        actualizarListadoCandidatos();
    }
    
    // Función para actualizar el listado de candidatos en el modal
    function actualizarListadoCandidatos() {
        var checkboxes = $('.checkbox-finalista:checked');
        var listado = $('#listadoCandidatos');
        listado.empty();
        
        if (checkboxes.length === 0) {
            listado.html('<div class="text-muted text-center">No hay candidatos seleccionados</div>');
            return;
        }
        
        var html = '<div class="row g-2">';
        checkboxes.each(function() {
            var nombre = $(this).data('nombre');
            var email = $(this).data('email');
            var imagen = $(this).data('imagen');
            var id = $(this).data('id');
            
            html += '<div class="col-12">';
            html += '<div class="d-flex align-items-center p-2 border rounded mb-2">';
            html += '<img src="' + imagen + '" alt="' + nombre + '" class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">';
            html += '<div class="flex-grow-1">';
            html += '<div class="fw-semibold">' + nombre + '</div>';
            html += '<small class="text-muted">' + email + '</small>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
        });
        html += '</div>';
        listado.html(html);
    }
    
    // Checkbox "Seleccionar todos"
    $('#selectAllFinalistas').on('change', function() {
        var isChecked = $(this).is(':checked');
        $('.checkbox-finalista').prop('checked', isChecked);
        actualizarSeleccion();
    });
    
    // Checkboxes individuales
    $(document).on('change', '.checkbox-finalista', function() {
        // Si se desmarca uno, desmarcar "seleccionar todos"
        if (!$(this).is(':checked')) {
            $('#selectAllFinalistas').prop('checked', false);
        } else {
            // Si todos están marcados, marcar "seleccionar todos"
            var total = $('.checkbox-finalista').length;
            var checked = $('.checkbox-finalista:checked').length;
            if (total === checked) {
                $('#selectAllFinalistas').prop('checked', true);
            }
        }
        actualizarSeleccion();
    });
    
    // Botón para abrir modal
    $('#btnAsignarEntrevistas').on('click', function() {
        var checkboxes = $('.checkbox-finalista:checked');
        if (checkboxes.length === 0) {
            alert('Por favor seleccione al menos un candidato');
            return;
        }
        
        // Recopilar IDs de las aplicaciones seleccionadas
        var ids = [];
        checkboxes.each(function() {
            ids.push($(this).data('id'));
        });
        
        // Actualizar input hidden con los IDs
        $('#aplicacionesIdsInput').val(ids.join(','));
        
        // Actualizar listado en el modal
        actualizarListadoCandidatos();
        
        // Abrir modal
        var modal = new bootstrap.Modal(document.getElementById('modalAsignarEntrevistas'));
        modal.show();
        
        // Inicializar Select2 en los campos del formulario dentro del modal
        setTimeout(function() {
            if ($('#id_entrevistador').length) {
                initializeSelect2('#id_entrevistador');
            }
            if ($('#id_tipo_entrevista').length) {
                initializeSelect2('#id_tipo_entrevista');
            }
        }, 300);
    });
    
    // Limpiar selección al cerrar el modal
    $('#modalAsignarEntrevistas').on('hidden.bs.modal', function() {
        // No limpiar los checkboxes, solo resetear el formulario si es necesario
    });
});
</script>  
{% endblock js %}

